<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DigiKeys DZ</title>

  <!-- Email webhook URL (optional). If empty, orders copy to clipboard. -->
  <script>
    // window.EMAIL_WEBHOOK_URL = "https://your-function-url";
    window.EMAIL_WEBHOOK_URL = "";
  </script>

  <style>
    :root{
      --bg:#f6f6f7; --text:#111; --muted:#666; --line:#e4e4e7; --card:#fff;
      --brand:#111; --brand-2:#333; --accent:#0ea5e9; --warn:#eab308; --ok:#16a34a; --danger:#dc2626;
      --radius:14px; --radius-sm:10px; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    /* Header */
    .site-header{position:sticky;top:0;z-index:50;background:#fffbd0; /* subtle brand band */ }
    .site-header__inner{max-width:1120px;margin:auto;padding:10px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--line);background:#fff}
    .brand{display:flex;align-items:center;gap:8px}
    .brand__logo{width:28px;height:28px;border-radius:9px;background:var(--brand)}
    .brand__name{font-weight:800;letter-spacing:.2px}
    .header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .input{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;min-width:220px}
    .select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
    .button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .button--brand{background:var(--brand);color:#fff;border-color:var(--brand)}
    .button--brand:hover{background:var(--brand-2)}
    .button--ghost:hover{background:#f8f8f8}

    /* Layout */
    .container{max-width:1120px;margin:auto;padding:24px 16px}
    .hero{display:grid;gap:20px;grid-template-columns:1fr;align-items:center;background:linear-gradient(135deg,#111,#444);padding:22px;border-radius:20px;color:#fff}
    @media (min-width:860px){.hero{grid-template-columns:1.2fr .8fr}}
    .hero__title{font-weight:800;font-size:32px;line-height:1.15}
    .hero__text{color:#ddd}
    .hero__actions{display:flex;gap:10px;margin-top:10px}
    .hero__img{aspect-ratio:16/9;border-radius:18px;overflow:hidden}
    .hero__img img{width:100%;height:100%;object-fit:cover;opacity:.9}

    /* Catalog */
    .grid{display:grid;gap:14px}
    .grid--cards{grid-template-columns:repeat(1,minmax(0,1fr))}
    @media (min-width:640px){.grid--cards{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:960px){.grid--cards{grid-template-columns:repeat(4,1fr)}}
    .product-card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .product-card__media{border-radius:var(--radius);overflow:hidden;position:relative}
    .badge{position:absolute;left:10px;top:10px;background:#fff;border-radius:999px;padding:4px 8px;font-size:12px;border:1px solid var(--line)}
    .product-card__row{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
    .product-card__title{font-weight:700}
    .product-card__meta{font-size:13px;color:var(--muted)}
    .price{font-weight:800}

    /* Info tiles */
    .tile{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    .tile__title{font-weight:700;margin-top:6px}

    /* Drawer (no dark overlay) */
    .drawer{position:fixed;inset:0;pointer-events:none;z-index:60}
    .drawer__panel{pointer-events:auto;margin-left:auto;height:100%;width:min(420px,100%);background:#fff;border-left:1px solid var(--line);box-shadow:var(--shadow);padding:16px;overflow:auto}
    .drawer__head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .drawer__title{font-weight:800}
    .drawer__close{border:1px solid var(--line);border-radius:8px;background:#fff;padding:6px 8px;cursor:pointer}
    .inline{display:flex;gap:10px;align-items:center}
    .stack{display:grid;gap:10px}
    .stack--lg{gap:14px}

    /* Checkout */
    .section{margin-top:26px}
    .form-label{font-size:14px;font-weight:600;margin-bottom:6px}
    .field{width:100%;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
    .note{font-size:12px;color:var(--muted)}
    .notice{border:1px solid #fde68a;background:#fffbeb;border-radius:10px;padding:10px;font-size:14px}
    .notice--blue{border-color:#bfdbfe;background:#eff6ff}
    .notice--green{border-color:#bbf7d0;background:#f0fdf4}
    .error{border:1px solid #fecaca;background:#fff1f2;border-radius:10px;padding:10px;color:#b91c1c;font-size:14px}

    /* Orders */
    .orders{display:grid;gap:10px}
    .order-card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .muted{color:var(--muted)}

    /* Auth */
    .auth-bar{display:flex;gap:8px;align-items:center}
    .auth-name{font-weight:700}
    .auth-link{border:1px solid var(--line);padding:6px 8px;border-radius:8px;cursor:pointer;background:#fff}
    .auth-panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px}
    .auth-row{display:grid;gap:8px;margin-bottom:10px}

    /* Footer */
    .site-footer{background:#fff;border-top:1px solid var(--line);margin-top:30px}
    .site-footer__inner{max-width:1120px;margin:auto;padding:18px 16px;display:grid;gap:10px;grid-template-columns:repeat(1,1fr)}
    @media (min-width:800px){.site-footer__inner{grid-template-columns:repeat(4,1fr)}}
    .copyright{text-align:center;font-size:12px;color:var(--muted);border-top:1px solid var(--line);padding:10px 0}

    /* Utility */
    .hidden{display:none}
    .right{margin-left:auto}
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="site-header">
    <div class="site-header__inner">
      <div class="brand">
        <div class="brand__logo"></div>
        <div class="brand__name">DigiKeys DZ</div>
      </div>

      <input id="searchInput" class="input" placeholder="Search games, passes, top-upsâ€¦"/>
      <select id="platformFilter" class="select"></select>

      <div class="auth-bar right" id="authBar">
        <!-- Filled by JS (login/signup or user info) -->
      </div>

      <button class="button" id="cartBtn">Cart <span id="cartBadge"></span></button>
      <button class="button" id="adminBtn" title="Admin panel" style="display:none">Admin</button>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <div>
        <h1 class="hero__title">Buy digital games & top-ups â€” instant delivery</h1>
        <p class="hero__text">Secure checkout. DZ-friendly. PS, Xbox, Steam, Riot and more.</p>
        <div class="hero__actions">
          <a href="#catalog" class="button button--brand">Shop now</a>
          <a href="#catalog" class="button button--ghost">Browse catalog</a>
        </div>
      </div>
      <div class="hero__img">
        <img src="https://images.unsplash.com/photo-1542751110-97427bbecf20?q=80&w=1600&auto=format&fit=crop" alt="Gaming">
      </div>
    </section>

    <!-- CATALOG -->
    <section id="catalog" class="section">
      <h2>Featured</h2>
      <div id="catalogGrid" class="grid grid--cards"></div>
    </section>

    <!-- INFO -->
    <section class="section grid" style="grid-template-columns:repeat(3,1fr);gap:14px">
      <div class="tile"><div>âš¡</div><div class="tile__title">Instant Delivery</div><div class="muted">Digital codes delivered within minutes after payment.</div></div>
      <div class="tile"><div>ðŸ’³</div><div class="tile__title">Manual Payments</div><div class="muted">BaridiMob, CCP, or Flexy â€” your choice.</div></div>
      <div class="tile"><div>ðŸ’¬</div><div class="tile__title">Support</div><div class="muted">We speak DZ/FR/EN. WhatsApp available.</div></div>
    </section>

    <!-- ORDERS LIST -->
    <section id="orders" class="section">
      <h2>Recent Orders</h2>
      <div id="ordersList" class="orders"></div>
    </section>

    <!-- AUTH PANELS -->
    <section id="authPanels" class="section grid" style="grid-template-columns:repeat(2,1fr);gap:14px"></section>
  </main>

  <!-- DRAWERS -->
  <div id="cartDrawer" class="drawer hidden">
    <div class="drawer__panel">
      <div class="drawer__head">
        <div class="drawer__title">Your Cart</div>
        <button class="drawer__close" data-close>Close</button>
      </div>
      <div id="cartContent" class="stack"></div>
    </div>
  </div>

  <div id="checkoutDrawer" class="drawer hidden">
    <div class="drawer__panel">
      <div class="drawer__head">
        <div class="drawer__title">Checkout</div>
        <button class="drawer__close" data-close>Close</button>
      </div>
      <div id="checkoutFormWrap" class="stack"></div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer__inner">
      <div>
        <div class="inline"><div class="brand__logo"></div><div class="brand__name">DigiKeys DZ</div></div>
        <p class="muted">Digital games, top-ups, and passes. Algeria-based, global delivery.</p>
      </div>
      <div>
        <h4>Support</h4>
        <div class="muted">FAQ<br/>Refund Policy<br/>Terms & Privacy</div>
      </div>
      <div>
        <h4>Payments</h4>
        <div class="muted">BaridiMob â€¢ CCP â€¢ Flexy (Flexy +18%).</div>
      </div>
      <div>
        <h4>Contact</h4>
        <div class="muted">WhatsApp: +213 â€¢ Email: hello@digikeys.dz</div>
      </div>
    </div>
    <div class="copyright">Â© <span id="year"></span> DigiKeys DZ. All rights reserved.</div>
  </footer>

  <script>
    /* =========================
       CONFIG (edit your details)
       ========================= */
    const CATALOG = [
      { id:"xbox-ultimate-1", title:"Xbox Game Pass Ultimate (1 Month)", platform:"Xbox", region:"Global",   price:3200, stock:12, img:"https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1200&auto=format&fit=crop" },
      { id:"psn-plus-3",      title:"PlayStation Plus Essential (3 Months)", platform:"PlayStation", region:"EU / MENA", price:6900, stock:9,  img:"https://images.unsplash.com/photo-1605901309584-818e25960a8b?q=80&w=1200&auto=format&fit=crop" },
      { id:"steam-wallet-20", title:"Steam Wallet Code â€“ 20â‚¬",               platform:"Steam", region:"EU",  price:4200, stock:25, img:"https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1200&auto=format&fit=crop" },
      { id:"valorant-1250",   title:"Valorant Points â€“ 1250",                platform:"Riot",  region:"EU / MENA", price:5100, stock:15, img:"https://images.unsplash.com/photo-1542751110-97427bbecf20?q=80&w=1200&auto=format&fit=crop" },
      { id:"fc25-ps5",        title:"EA FC 25 (PS5 Digital)",                platform:"PlayStation", region:"EU / MENA", price:11900, stock:6, img:"https://images.unsplash.com/photo-1605901309584-818e25960a8b?q=80&w=1200&auto=format&fit=crop" },
      { id:"elden-ps5",       title:"ELDEN RING (PS5 Digital)",              platform:"PlayStation", region:"Global",  price:9500, stock:4,  img:"https://images.unsplash.com/photo-1605901309584-818e25960a8b?q=80&w=1200&auto=format&fit=crop" },
      { id:"cod-bp",          title:"CoD Battle Pass (Cross-Gen)",           platform:"Multi-Platform", region:"Global", price:3900, stock:20, img:"https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1200&auto=format&fit=crop" },
    ];
    const FLEXY_PHONE      = "+213-55-000-0000";
    const BARIDIMOB_IBAN   = "DZ58 0000 0000 0000 0000 0000";
    const CCP_NUMBER       = "00000000";
    const CCP_NAME         = "YOUR NAME";
    const SUPPORT_WHATSAPP = "+213-55-111-2222";
    const PROCESSING_NOTE  = "Orders are reviewed and delivered within ~5 minutes after payment proof is received.";

    // Admin account (change this!)
    const DEFAULT_ADMIN = { email: "admin@digikeys.dz", password: "admin123", role: "admin" };

    const fmtDA = new Intl.NumberFormat("fr-DZ", { style:"currency", currency:"DZD", maximumFractionDigits:0 });
    const digitsOnly = (s="") => String(s).replace(/\D/g,"");

    /* ============ STATE (localStorage) ============ */
    const db = {
      get users(){ return JSON.parse(localStorage.getItem("users") || "[]"); },
      set users(v){ localStorage.setItem("users", JSON.stringify(v)); },
      get session(){ return JSON.parse(localStorage.getItem("sessionUser") || "null"); },
      set session(v){ localStorage.setItem("sessionUser", JSON.stringify(v)); },
      get cart(){ return JSON.parse(localStorage.getItem("cart") || "{}"); },
      set cart(v){ localStorage.setItem("cart", JSON.stringify(v)); },
      get orders(){ return JSON.parse(localStorage.getItem("orders") || "[]"); },
      set orders(v){ localStorage.setItem("orders", JSON.stringify(v)); },
    };

    // Seed default admin once
    (function seedAdmin(){
      const u = db.users;
      if(!u.find(x=>x.email===DEFAULT_ADMIN.email)){
        u.push({ id:crypto.randomUUID(), ...DEFAULT_ADMIN });
        db.users = u;
      }
    })();

    /* ============ RENDER HELPERS ============ */
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls, html) => {
      const e = document.createElement(tag);
      if(cls) e.className = cls;
      if(html!==undefined) e.innerHTML = html;
      return e;
    };

    const yearSpan = $("#year");
    yearSpan.textContent = new Date().getFullYear();

    /* ============ AUTH ============ */
    function renderAuthBar(){
      const bar = $("#authBar");
      bar.innerHTML = "";
      const user = db.session;
      if(!user){
        const login = el("button","auth-link","Log in");
        const signup = el("button","auth-link","Sign up");
        login.onclick = () => showAuthPanels("login");
        signup.onclick = () => showAuthPanels("signup");
        bar.append(login, signup);
      }else{
        const name = el("div","auth-name", user.email);
        const logout = el("button","auth-link","Log out");
        logout.onclick = ()=>{ db.session=null; renderAuthBar(); renderAdminButton(); };
        bar.append(name, logout);
      }
    }
    function showAuthPanels(mode){
      const wrap = $("#authPanels");
      wrap.innerHTML = "";
      // LOGIN
      const loginBox = el("div","auth-panel");
      loginBox.innerHTML = `
        <h3>Log in</h3>
        <div class="auth-row">
          <label class="form-label">Email</label><input id="loginEmail" class="field" placeholder="you@example.com">
        </div>
        <div class="auth-row">
          <label class="form-label">Password</label><input id="loginPass" class="field" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="button button--brand" id="loginSubmit">Log in</button>
        <div class="note" style="margin-top:6px">Default admin: ${DEFAULT_ADMIN.email} / ${DEFAULT_ADMIN.password}</div>
      `;
      // SIGNUP
      const signupBox = el("div","auth-panel");
      signupBox.innerHTML = `
        <h3>Create account</h3>
        <div class="auth-row">
          <label class="form-label">Email</label><input id="signupEmail" class="field" placeholder="you@example.com">
        </div>
        <div class="auth-row">
          <label class="form-label">Password</label><input id="signupPass" class="field" type="password" placeholder="minimum 6 chars">
        </div>
        <button class="button button--brand" id="signupSubmit">Create account</button>
      `;
      wrap.append(loginBox, signupBox);
      if(mode==="signup") $("#signupEmail").focus(); else $("#loginEmail").focus();

      $("#loginSubmit").onclick = ()=>{
        const email=$("#loginEmail").value.trim(), pass=$("#loginPass").value;
        const u=db.users.find(x=>x.email===email && x.password===pass);
        if(!u){ alert("Invalid email or password"); return; }
        db.session={ id:u.id, email:u.email, role:u.role||"user" };
        wrap.innerHTML=""; renderAuthBar(); renderAdminButton();
      };
      $("#signupSubmit").onclick = ()=>{
        const email=$("#signupEmail").value.trim(), pass=$("#signupPass").value;
        if(!email || pass.length<6){ alert("Enter a valid email and a 6+ char password"); return; }
        if(db.users.find(x=>x.email===email)){ alert("Email already exists"); return; }
        const u={ id:crypto.randomUUID(), email, password:pass, role:"user" };
        db.users=[...db.users,u];
        db.session={ id:u.id, email:u.email, role:"user" };
        wrap.innerHTML=""; renderAuthBar(); renderAdminButton();
      };
    }
    function renderAdminButton(){
      const btn=$("#adminBtn");
      const isAdmin = db.session && db.session.role==="admin";
      btn.style.display = isAdmin ? "inline-block" : "none";
    }

    /* ============ CATALOG + CART ============ */
    // Filters
    const platformSet = new Set(["All", ...CATALOG.map(p=>p.platform)]);
    const platformSelect = $("#platformFilter");
    platformSet.forEach(p=>{
      const o=document.createElement("option"); o.value=p; o.textContent=p; platformSelect.append(o);
    });

    $("#searchInput").oninput = ()=> renderCatalog();
    platformSelect.onchange = ()=> renderCatalog();

    function renderCatalog(){
      const q=$("#searchInput").value.trim().toLowerCase();
      const plat=platformSelect.value;
      const list = CATALOG.filter(p =>
        (plat==="All"||p.platform===plat) && (!q || p.title.toLowerCase().includes(q))
      );
      const grid = $("#catalogGrid"); grid.innerHTML="";
      list.forEach(p=>{
        const card = el("div","product-card");
        card.innerHTML = `
          <div class="product-card__media">
            <img src="${p.img}" alt="">
            ${p.stock<5 ? '<div class="badge">Low stock</div>' : ''}
          </div>
          <div class="product-card__row">
            <div>
              <div class="product-card__title">${p.title}</div>
              <div class="product-card__meta">${p.platform} â€¢ ${p.region}</div>
            </div>
            <div style="text-align:right">
              <div class="price">${fmtDA.format(p.price)}</div>
              <button class="button button--brand" data-add="${p.id}" style="margin-top:6px">Add</button>
            </div>
          </div>`;
        grid.append(card);
      });
      grid.querySelectorAll("[data-add]").forEach(b=>{
        b.onclick=()=>{ addToCart(b.dataset.add); openCart(); };
      });
    }

    function addToCart(id){ const cart=db.cart; cart[id]=(cart[id]||0)+1; db.cart=cart; updateCartBadge(); }
    function updateQty(id, qty){
      const cart=db.cart;
      if(qty<=0) delete cart[id]; else cart[id]=qty;
      db.cart=cart;
      renderCart();
      updateCartBadge();
    }
    function clearCart(){ db.cart={}; renderCart(); updateCartBadge(); }
    function updateCartBadge(){
      const n = Object.values(db.cart).reduce((s,n)=>s+n,0);
      $("#cartBadge").textContent = n ? `(${n})` : "";
    }

    /* ============ CART DRAWER ============ */
    const cartDrawer = $("#cartDrawer");
    $("#cartBtn").onclick = openCart;
    cartDrawer.addEventListener("click", (e)=>{ if(e.target.hasAttribute("data-close")) closeCart(); });
    function openCart(){ renderCart(); cartDrawer.classList.remove("hidden"); }
    function closeCart(){ cartDrawer.classList.add("hidden"); }

    function renderCart(){
      const wrap=$("#cartContent"); wrap.innerHTML="";
      const items = Object.entries(db.cart).map(([id,qty])=>{
        const p = CATALOG.find(x=>x.id===id); return p ? {product:p, qty} : null;
      }).filter(Boolean);
      if(!items.length){ wrap.append(el("div","muted","Your cart is empty.")); return; }

      items.forEach(({product,qty})=>{
        const row = el("div","inline");
        row.style.justifyContent="space-between";
        row.innerHTML = `
          <div class="inline" style="gap:10px">
            <img src="${product.img}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid var(--line)"/>
            <div>
              <div style="font-weight:600">${product.title}</div>
              <div class="muted" style="font-size:13px">${product.platform} â€¢ ${product.region}</div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${fmtDA.format(product.price)}</div>
            <div class="inline" style="justify-content:flex-end;margin-top:4px">
              <button class="button" data-dec="${product.id}">-</button>
              <div>${qty}</div>
              <button class="button" data-inc="${product.id}">+</button>
            </div>
          </div>`;
        wrap.append(row);
      });

      const subtotal = items.reduce((s,i)=>s+i.product.price*i.qty,0);
      const summary = el("div","stack");
      summary.style.borderTop="1px solid var(--line)";
      summary.style.paddingTop="10px";
      const payMethod = currentPayment; // for preview of surcharge
      const surcharge = payMethod==="flexy" ? Math.round(subtotal*0.18) : 0;
      summary.innerHTML = `
        <div class="inline" style="justify-content:space-between">
          <div style="font-weight:700">Subtotal</div><div style="font-weight:800">${fmtDA.format(subtotal)}</div>
        </div>
        ${payMethod==="flexy"?`<div class="inline" style="justify-content:space-between;font-size:14px"><div>Flexy surcharge (+18%)</div><div>+ ${fmtDA.format(surcharge)}</div></div>`:""}
        <div class="inline" style="justify-content:space-between;font-size:14px"><div class="muted">Estimated total</div><div style="font-weight:700">${fmtDA.format(subtotal+surcharge)}</div></div>
        <div class="inline">
          <button class="button" id="clearCartBtn">Clear</button>
          <button class="button button--brand right" id="toCheckoutBtn">Checkout</button>
        </div>`;
      wrap.append(summary);

      wrap.querySelectorAll("[data-dec]").forEach(b=> b.onclick=()=>updateQty(b.dataset.dec,(db.cart[b.dataset.dec]||1)-1));
      wrap.querySelectorAll("[data-inc]").forEach(b=> b.onclick=()=>updateQty(b.dataset.inc,(db.cart[b.dataset.inc]||0)+1));
      $("#clearCartBtn").onclick = ()=>{ localStorage.removeItem("cart"); clearCart(); };
      $("#toCheckoutBtn").onclick = ()=>{ closeCart(); openCheckout(); };
    }

    /* ============ CHECKOUT DRAWER ============ */
    const checkoutDrawer = $("#checkoutDrawer");
    checkoutDrawer.addEventListener("click",(e)=>{ if(e.target.hasAttribute("data-close")) closeCheckout(); });
    function openCheckout(){ renderCheckoutForm(); checkoutDrawer.classList.remove("hidden"); }
    function closeCheckout(){ checkoutDrawer.classList.add("hidden"); }

    let currentPayment = "baridimob"; // used for surcharge preview in cart

    function renderCheckoutForm(){
      const wrap=$("#checkoutFormWrap"); wrap.innerHTML="";
      const items = Object.entries(db.cart).map(([id,qty])=>{
        const p=CATALOG.find(x=>x.id===id); return p?{product:p,qty}:null;
      }).filter(Boolean);
      const subtotal = items.reduce((s,i)=>s+i.product.price*i.qty,0);
      const surcharge = currentPayment==="flexy" ? Math.round(subtotal*0.18) : 0;
      const total = subtotal + surcharge;

      const user = db.session;

      const form = el("form","stack stack--lg");
      form.innerHTML = `
        <div id="checkoutError" class="error hidden"></div>

        <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
          <div>
            <div class="form-label">Full name</div>
            <input name="name" class="field" required />
          </div>
          <div>
            <div class="form-label">Email</div>
            <input name="email" type="email" class="field" required value="${user?user.email:""}"/>
          </div>
          <div style="grid-column:1/3">
            <div class="form-label">Phone (WhatsApp)</div>
            <input name="phone" class="field" placeholder="+213..." />
          </div>
        </div>

        <div class="stack">
          <div class="form-label">Delivery method</div>
          <select name="delivery" class="field">
            <option value="email">Email (instant)</option>
            <option value="whatsapp">WhatsApp message</option>
          </select>
        </div>

        <div class="stack">
          <div class="form-label">Payment method</div>
          <select name="payment" id="paymentSelect" class="field">
            <option value="baridimob">BaridiMob</option>
            <option value="ccp">CCP</option>
            <option value="flexy">Flexy (DZ mobile)</option>
          </select>

          <div id="paymentInfo"></div>
          <div class="note">${PROCESSING_NOTE}</div>
        </div>

        <div class="stack">
          <div class="form-label">Order note (optional)</div>
          <textarea name="note" class="field" rows="3" placeholder="Example: Send PSN code for EU region"></textarea>
        </div>

        <div class="stack">
          <div class="form-label">Upload payment proof (screenshot / PDF)</div>
          <input name="proof" type="file" accept="image/*,application/pdf" class="field" required />
        </div>

        <div class="stack" style="border:1px solid var(--line);border-radius:10px;padding:12px">
          <div class="form-label">Totals</div>
          <div class="inline" style="justify-content:space-between"><div>Subtotal</div><div>${fmtDA.format(subtotal)}</div></div>
          ${currentPayment==="flexy"?`<div class="inline" style="justify-content:space-between"><div>Flexy surcharge (18%)</div><div>+ ${fmtDA.format(surcharge)}</div></div>`:""}
          <div class="inline" style="justify-content:space-between;font-weight:800"><div>Total</div><div>${fmtDA.format(total)}</div></div>
        </div>

        <button class="button button--brand" type="submit">Submit & Send Proof</button>
      `;
      wrap.append(form);

      const paymentInfo = $("#paymentInfo");
      const paymentSelect = $("#paymentSelect");
      function renderPaymentInfo(){
        currentPayment = paymentSelect.value;
        paymentInfo.innerHTML = "";
        if(currentPayment==="flexy"){
          paymentInfo.innerHTML = `<div class="notice">Flexy to: <b>${FLEXY_PHONE}</b><br/>Flexy incurs <b>+18%</b> surcharge.</div>`;
        }else if(currentPayment==="baridimob"){
          paymentInfo.innerHTML = `<div class="notice notice--blue"><b>BaridiMob IBAN</b><br/><span class="muted">${BARIDIMOB_IBAN}</span></div>`;
        }else if(currentPayment==="ccp"){
          paymentInfo.innerHTML = `<div class="notice notice--green"><b>CCP Details</b><br/><span class="muted">${CCP_NUMBER} â€” ${CCP_NAME}</span></div>`;
        }
        renderCart(); // refresh cart totals preview
      }
      paymentSelect.value = currentPayment;
      renderPaymentInfo();
      paymentSelect.onchange = renderPaymentInfo;

      form.onsubmit = async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        if(!items.length){ showError("Your cart is empty."); return; }
        if(!fd.get("name") || !fd.get("email")){ showError("Name and email are required."); return; }

        const proofFile = form.querySelector('input[name="proof"]').files[0];
        const proofDataURL = await fileToDataURL(proofFile);

        const order = {
          id: "ORD-" + Math.random().toString(36).slice(2,8).toUpperCase(),
          at: new Date().toISOString(),
          user: db.session ? { id: db.session.id, email: db.session.email } : null,
          customer: { name: fd.get("name"), email: fd.get("email"), phone: fd.get("phone")||"" },
          items: items.map(i=>({ id:i.product.id, title:i.product.title, qty:i.qty, price:i.product.price })),
          subtotal,
          surchargePct: currentPayment==="flexy"?18:0,
          total,
          payment: { method: currentPayment, delivery: fd.get("delivery"), note: fd.get("note")||"" },
          proof: { filename: proofFile?.name||"", mime: proofFile?.type||"", dataURL: proofDataURL },
          status: "awaiting-verification",
        };

        const prev = db.orders; prev.unshift(order); db.orders=prev;
        await sendOrderEmail({
          type:"new_order",
          subject:`[DigiKeys DZ] New order ${order.id}`,
          to:"you@example.com",
          order,
          processing_note: PROCESSING_NOTE,
          payment_targets:{ flexy_phone:FLEXY_PHONE, baridimob_iban:BARIDIMOB_IBAN, ccp_number:CCP_NUMBER, ccp_name:CCP_NAME }
        });

        db.cart = {}; updateCartBadge(); renderOrders(); closeCheckout();
        alert(`Order ${order.id} received. We'll verify and deliver shortly.`);
      };

      function showError(msg){
        const e=$("#checkoutError"); e.textContent=msg; e.classList.remove("hidden");
        setTimeout(()=>e.classList.add("hidden"),4000);
      }
    }

    async function fileToDataURL(file){
      if(!file) return "";
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(String(fr.result));
        fr.onerror=reject;
        fr.readAsDataURL(file);
      });
    }
    async function sendOrderEmail(payload){
      try{
        if(window.EMAIL_WEBHOOK_URL){
          const res = await fetch(window.EMAIL_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
          if(!res.ok) throw new Error("Webhook non-200");
          return true;
        }
        await navigator.clipboard.writeText(JSON.stringify(payload,null,2));
        alert("No EMAIL_WEBHOOK_URL set. Order details copied to clipboard.");
        return false;
      }catch(e){ console.error(e); return false; }
    }

    /* ============ ORDERS RENDER ============ */
    function renderOrders(){
      const list=$("#ordersList"); list.innerHTML="";
      const orders = db.orders;
      if(!orders.length){ list.append(el("div","muted","No orders yet.")); return; }
      orders.forEach(o=>{
        const card=el("div","order-card");
        const total = fmtDA.format(o.total);
        const phoneLink = o.customer?.phone ? 
          `https://wa.me/${digitsOnly(o.customer.phone)}?text=${encodeURIComponent(`Salam, this is DigiKeys DZ. We received your order ${o.id} (${total}), payment: ${o.payment?.method}. We'll verify your proof and deliver within ~5 minutes. Merci!`)}` : null;
        const internalLink =
          `https://wa.me/${digitsOnly(SUPPORT_WHATSAPP)}?text=${encodeURIComponent(`Order ${o.id} â€” Total ${total} â€” ${o.customer.name} (${o.customer.email} ${o.customer.phone? 'â€¢ '+o.customer.phone:''}) â€” Payment: ${o.payment?.method}`)}`;
        card.innerHTML=`
          <div class="inline" style="justify-content:space-between">
            <div style="font-weight:700">${o.id}</div>
            <div class="muted">${new Date(o.at).toLocaleString()}</div>
          </div>
          <div class="muted" style="margin-top:4px">${o.customer.name} â€¢ ${o.customer.email} ${o.customer.phone? 'â€¢ '+o.customer.phone:''}</div>
          <ul class="muted" style="margin:6px 0 4px 18px">
            ${o.items.map(i=>`<li>${i.title} Ã— ${i.qty} â€” <b>${fmtDA.format(i.price*i.qty)}</b></li>`).join("")}
          </ul>
          <div class="muted">Payment: <b style="text-transform:capitalize">${o.payment?.method}</b>${o.surchargePct?` (+${o.surchargePct}% surcharge)`:''}</div>
          <div>Total: <b>${total}</b></div>
          <div class="inline" style="gap:8px;margin-top:8px;flex-wrap:wrap">
            ${o.proof?.dataURL?`<a class="button" href="${o.proof.dataURL}" download="${o.id}-proof">Download proof</a>`:''}
            ${phoneLink?`<a class="button" target="_blank" href="${phoneLink}">WhatsApp customer</a>`:''}
            <a class="button" target="_blank" href="${internalLink}">WhatsApp (internal)</a>
          </div>
        `;
        list.append(card);
      });
    }

    /* ============ ADMIN PANEL ============ */
    $("#adminBtn").onclick = ()=>{
      const panel = el("div","drawer");
      panel.innerHTML = `
        <div class="drawer__panel">
          <div class="drawer__head">
            <div class="drawer__title">Admin â€” Orders</div>
            <button class="drawer__close" data-close>Close</button>
          </div>
          <div id="adminOrders" class="stack"></div>
          <div class="auth-panel" style="margin-top:12px">
            <div class="form-label">Email webhook tips</div>
            <div class="muted" style="font-size:13px">Deploy a tiny Netlify/Cloudflare function and set <code>window.EMAIL_WEBHOOK_URL</code> to its URL to receive emails for each order.</div>
          </div>
        </div>`;
      document.body.append(panel);
      renderAdminOrders(panel.querySelector("#adminOrders"));
      panel.addEventListener("click",(e)=>{ if(e.target.hasAttribute("data-close")) panel.remove(); });
    };

    function renderAdminOrders(target){
      const orders=db.orders;
      target.innerHTML = orders.length ? "" : `<div class="muted">No orders yet.</div>`;
      orders.forEach(o=>{
        const row=el("div","order-card");
        row.innerHTML = `
          <div class="inline" style="justify-content:space-between">
            <div style="font-weight:700">${o.id}</div>
            <div class="muted" style="font-size:12px">${new Date(o.at).toLocaleString()}</div>
          </div>
          <div class="muted" style="margin-top:4px">${o.customer.name} â€¢ ${o.customer.email} ${o.customer.phone? 'â€¢ '+o.customer.phone:''}</div>
          <div class="muted">Total: <b>${fmtDA.format(o.total)}</b> â€¢ Payment: <b style="text-transform:capitalize">${o.payment?.method}</b></div>
          <div class="inline" style="gap:8px;flex-wrap:wrap;margin-top:8px">
            <label class="inline" style="gap:6px">Status
              <select data-status class="field" style="padding:6px 8px;width:auto">
                <option value="awaiting-verification">Awaiting verification</option>
                <option value="verified">Verified</option>
                <option value="fulfilled">Fulfilled</option>
              </select>
            </label>
            ${o.proof?.dataURL?`<a class="button" href="${o.proof.dataURL}" download="${o.id}-proof">Download proof</a>`:''}
            <button class="button" data-delete>Delete</button>
          </div>`;
        const sel = row.querySelector("[data-status]"); sel.value = o.status || "awaiting-verification";
        sel.onchange = ()=>{ o.status=sel.value; db.orders=[...orders]; renderOrders(); };
        row.querySelector("[data-delete]").onclick = ()=>{ const next=orders.filter(x=>x.id!==o.id); db.orders=next; renderAdminOrders(target); renderOrders(); };
        target.append(row);
      });
    }

    /* ============ INIT ============ */
    renderAuthBar();
    renderAdminButton();
    renderCatalog();
    renderOrders();
    updateCartBadge();
  </script>
</body>
</html>
