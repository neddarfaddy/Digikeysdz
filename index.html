<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Digikeys</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://wsrv.nl" crossorigin>
  <style>
    :root{
      --page-bg:#1b193b; --app-bg:#151437; --nav-bg:#2c2f66;
      --text:#fff; --muted:#a8adca; --accent:#00ff84;
      --chip-red:#ff4d5a; --card:#1d1c44; --card-hover:#24235a;
      --shadow:0 8px 24px rgba(0,0,0,.25); --radius:14px;
    }
    html{scroll-behavior:smooth;background:var(--page-bg);overflow-x:hidden;background-color:#151437;}
    *,*::before,*::after{box-sizing:border-box}

    body{margin:0;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}

    header{
      position:fixed;inset:0 0 auto 0;height:64px;z-index:50;background:var(--nav-bg);
      display:flex;align-items:center;padding:0 12px;box-shadow:0 2px 10px rgba(0,0,0,.25)
    }
    .nav{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;width:100%}
    .nav-left{justify-self:start;display:flex;align-items:center;gap:12px}
    .nav-center{justify-self:center;display:flex;align-items:center}
    .nav-right{justify-self:end;display:flex;align-items:center}
    .hamburger{width:28px;height:22px}
    .logo{height:22px}
    .cart-link,.icon-btn{background:transparent;border:none;padding:0;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .cart-link:focus,.icon-btn:focus{outline:none}
    .cart-icon{width:28px;height:28px}

    .app{margin:0 auto;background:var(--app-bg);min-height:100vh;padding:88px 16px 120px;max-width:430px}

    .search{width:100%;height:40px;border:none;border-radius:999px;padding:0 16px 0 40px;color:#131321;
      background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>') no-repeat 12px center;font-size:14px}
    .search-wrap{margin-bottom:12px}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;background:#20214a;color:#cfd2ff;border:1px solid #2a2b55;font-weight:700;font-size:12px}
    .tab.active{background:var(--accent);color:#07101c;border-color:transparent}

    .hero{position:relative;overflow:hidden;border-radius:var(--radius);box-shadow:var(--shadow);aspect-ratio:16/9;margin-bottom:12px}
    .slides{display:flex;width:100%;height:100%;transition:transform .4s ease}
    .slide{position:relative;min-width:100%;height:100%;background:#2a295d center/cover no-repeat}
    .pill{position:absolute;left:16px;bottom:16px;background:var(--accent);color:#0a0f17;border-radius:999px;padding:8px 14px;font-weight:500;font-size:12px;box-shadow:0 6px 16px rgba(0,255,132,.35)}
    .dots{display:flex;gap:8px;justify-content:center;margin:12px 0 20px}
    .dot{width:8px;height:8px;border-radius:50%;background:#4c4b86;opacity:.8}
    .dot.active{background:#24d07a;opacity:1}

    .section-title{font-size:28px;font-weight:700;margin:8px 0 12px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:var(--card);border-radius:16px;overflow:hidden;transition:transform .15s ease,background .15s ease}
    .card:hover{transform:translateY(-2px);background:var(--card-hover)}
    .thumb{position:relative;aspect-ratio:3/4;background:#262557}
    .thumb img.cover{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;right:8px;bottom:8px;background:var(--chip-red);color:#fff;font-weight:500;font-size:11px;padding:6px 8px;border-radius:999px}
    .platform{position:absolute;left:8px;bottom:8px;width:18px;height:18px;border-radius:50%;background:#0008;border:1px solid #fff3}
    .card-body{padding:10px 12px 12px}
    .title{font-size:12px;line-height:1.3;min-height:32px;font-weight:500}
    .sub{font-size:11px;color:#bfc3ee;margin-top:2px;min-height:16px}
    .actions{display:flex;gap:8px;margin-top:8px}
    .btn{flex:1;display:inline-flex;justify-content:center;align-items:center;height:34px;border:none;border-radius:10px;font-weight:500}
    .btn-add{background:#24d07a;color:#0b1320}
    .btn-add:active{transform:translateY(1px)}
    .price{font-size:13px;color:#e7e9ff;margin-top:6px}

    /* Drawer */
    .drawer{position:fixed;inset:0 0 0 auto;width:min(92vw,420px);background:#0f102b;transform:translateX(100%);transition:transform .25s ease;z-index:70;display:flex;flex-direction:column}
    .drawer.open{transform:none}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#191a40;border-bottom:1px solid #2a2b55}
    .drawer-title{font-weight:500}
    .drawer-body{padding:14px 16px;overflow:auto;flex:1}
    .drawer-foot{padding:12px 16px;border-top:1px solid #2a2b55;background:#15163a;display:grid;gap:10px}
    .x{background:none;border:none;color:#fff;font-size:20px}

    .cart-items{display:grid;gap:10px;margin-bottom:14px}
    .cart-item img{width:56px;height:56px;border-radius:8px;object-fit:cover;background:#2a295d}
    .cart-item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;background:#161741;border-radius:12px;padding:8px}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:26px;height:26px;border:none;border-radius:8px;background:#282a60;color:#fff}
    .remove{background:none;border:none;color:#ff7b86}

    .row{display:grid;gap:6px;margin:10px 0}
    .label{font-size:12px;color:var(--muted)}
    .input,.select,.textarea{width:100%;height:38px;border:1px solid #2a2b55;border-radius:10px;background:#0f102b;color:#fff;padding:0 12px}
    .textarea{height:72px;padding:8px 12px;resize:vertical}
    input[type="file"].input{height:auto;padding:10px 12px;display:block;cursor:pointer}

    .info{background:#11123a;border:1px solid #2a2b55;border-radius:10px;padding:10px 12px;font-size:13px;line-height:1.4}
    .info b{font-weight:500}

    .totals{display:grid;gap:6px;margin:10px 0;font-size:14px}
    .totals .line{display:flex;justify-content:space-between}
    .grand{font-weight:500}
    .hint{font-size:12px;color:var(--muted)}
    .small{font-size:11px;color:var(--muted)}

    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:60}
    .backdrop.show{opacity:1;pointer-events:auto}

    .load-more{margin:16px 0 24px;display:flex;justify-content:center}
    .load-more button{background:#2a2b55;color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:500}

    .menu{position:fixed;inset:0 auto 0 0;width:min(86vw,360px);background:#13143a;transform:translateX(-100%);transition:transform .25s ease;z-index:70;display:flex;flex-direction:column;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .menu.open{transform:none}
    .menu-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#191a40;border-bottom:1px solid #2a2b55;font-weight:600}
    .menu-body{padding:12px 0;overflow:auto;flex:1}
    .menu-title{color:#a8adca;font-size:13px;padding:8px 16px 6px}
    .menu-item{width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:14px 16px;background:transparent;color:#fff;border:none;text-align:left;cursor:pointer}
    .menu-item:hover{background:#1b1c45}
    .menu-item a{color:inherit;text-decoration:none;flex:1}
    .chev{opacity:.7}
    .sep{height:1px;background:#2a2b55;margin:8px 16px}

    .btn-primary{height:42px;border:none;border-radius:10px;background:var(--accent);color:#07101c;font-weight:500}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="nav-left">
        <button class="icon-btn" id="openMenu" aria-label="Open menu"><img class="hamburger" src="./imgs/hamburger.png" alt=""></button>
      </div>
      <div class="nav-center">
        <img class="logo" src="./imgs/Logo.png" alt="DIGIKEYS.">
      </div>
      <div class="nav-right">
        <button class="cart-link" id="openCart" aria-label="Open cart">
          <img class="cart-icon" src="./imgs/shopping-cart.png" alt="Cart">
        </button>
      </div>
    </nav>
  </header>

  <div class="backdrop" id="backdrop"></div>

  <aside class="menu" id="menuDrawer" aria-label="Main menu">
    <div class="menu-head">
      <span>Menu</span>
      <button class="x" id="closeMenu" aria-label="Close">✕</button>
    </div>
    <div class="menu-body">
      <div class="menu-group">
        <div class="menu-title">Connect</div>
        <a class="menu-item" href="https://www.instagram.com/digikeys_dz/" target="_blank" rel="noopener"><span>Instagram</span><span class="chev">›</span></a>
        <a class="menu-item" href="https://www.facebook.com/profile.php?id=61570530206331" target="_blank" rel="noopener"><span>Facebook</span><span class="chev">›</span></a>
        <a class="menu-item" href="mailto:digikeysdz@gmail.com"><span>Email</span><span class="chev">›</span></a>
      </div>
      <div class="sep"></div>
      <div class="menu-group">
        <div class="menu-title">Platforms</div>
        <button class="menu-item" data-platform="PC"><span>PC</span><span class="chev">›</span></button>
        <button class="menu-item" data-platform="PS5"><span>PLAYSTATION</span><span class="chev">›</span></button>
        <button class="menu-item" data-platform="Xbox"><span>XBOX</span><span class="chev">›</span></button>
        <button class="menu-item" data-platform="Switch"><span>SWITCH</span><span class="chev">›</span></button>
      </div>
    </div>
  </aside>

  <!-- Cart Drawer -->
  <aside class="drawer" id="cartDrawer" aria-label="Cart">
    <div class="drawer-head">
      <div class="drawer-title">Your Cart</div>
      <button class="x" id="closeCart" aria-label="Close">✕</button>
    </div>

    <div class="drawer-body">
      <form id="orderForm" method="POST" action="https://formsubmit.co/digikeysdz@gmail.com" enctype="multipart/form-data">
        <input type="hidden" name="_subject" value="New Order - Digikeys">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_template" value="table">

        <div class="cart-items" id="cartItems"></div>

        <div class="row">
          <label class="label" for="paymentMethod">Payment method</label>
          <select id="paymentMethod" name="payment_method_select" class="select">
            <option value="baridimob">BaridiMob</option>
            <option value="flexy">Flexy (+18%)</option>
            <option value="ccp">CCP</option>
          </select>
          <div class="hint">Flexy adds an 18% service fee.</div>
        </div>

        <div class="row" id="payInfoRow">
          <div class="label" id="payInfoLabel">Payment info</div>
          <div class="info" id="payInfo"></div>
        </div>

        <div id="proofRow">
          <div class="row">
            <label class="label" for="proofFile">Payment proof (image or PDF)</label>
            <input id="proofFile" name="payment_proof" class="input" type="file" accept="image/*,.pdf"/>
          </div>
        </div>

        <div id="flexyExtraRows" style="display:none;">
          <div class="row">
            <label class="label" for="flexyTime">Exact time paid</label>
            <input id="flexyTime" class="input" type="datetime-local"/>
          </div>
          <div class="row">
            <label class="label" for="flexyAmount">Exact amount (DA)</label>
            <input id="flexyAmount" class="input" type="number" min="0" step="1" placeholder="e.g., 1500"/>
          </div>
        </div>

        <div class="row">
          <label class="label">Contact (email or phone)</label>
          <input id="contactEmail" name="email" class="input" type="email" placeholder="Email (optional)"/>
          <input id="contactPhone" name="phone" class="input" type="tel" placeholder="Phone (optional)"/>
          <div class="hint">At least one is required.</div>
        </div>

        <div class="row">
          <label class="label" for="notes">Notes (optional)</label>
          <textarea id="notes" name="notes" class="textarea" placeholder="Add any details for your order"></textarea>
        </div>

        <div class="totals">
          <div class="line"><span>Subtotal</span><span id="subtotal">0 DA</span></div>
          <div class="line" id="feeLine" style="display:none;"><span>Flexy fee (18%)</span><span id="feeValue">0 DA</span></div>
          <div class="line grand"><span>Total</span><span id="grandTotal">0 DA</span></div>
        </div>
        <p class="small">Orders are sent to <strong>digikeysdz@gmail.com</strong>. You’ll receive a confirmation reply.</p>

        <input type="hidden" name="items" id="f_items">
        <input type="hidden" name="subtotal_pretty" id="f_subtotal">
        <input type="hidden" name="fee_pretty" id="f_fee">
        <input type="hidden" name="total_pretty" id="f_total">
        <input type="hidden" name="payment_method" id="f_method">
        <input type="hidden" name="flexy_time" id="f_flexy_time">
        <input type="hidden" name="flexy_amount" id="f_flexy_amount">
        <input type="hidden" name="notes_copy" id="f_notes">
      </form>
    </div>

    <div class="drawer-foot">
      <button class="btn-primary" id="sendOrder" type="submit" form="orderForm">Send Order</button>
      <button class="btn" id="clearCart" type="button" style="background:#2a2b55;color:#fff;">Clear Cart</button>
    </div>
  </aside>

  <main class="app">
    <div class="search-wrap"><input class="search" id="searchInput" type="search" placeholder="Search by title..." /></div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-platform="All">All</button>
      <button class="tab" data-platform="PC">PC</button>
      <button class="tab" data-platform="PS5">PS5</button>
      <button class="tab" data-platform="Xbox">Xbox</button>
      <button class="tab" data-platform="Switch">Switch</button>
    </div>
    <section class="hero">
      <div class="slides" id="slides">
        <div class="slide" style="background-image:url(./imgs/Silksong_desktop.webp);"><span class="pill">NEW RELEASE</span></div>
        <div class="slide" style="background-image:url(./imgs/Helldivers.webp);"><span class="pill">HOT DEAL</span></div>
        <div class="slide" style="background-image:url(./imgs/MetalGearSnakeEater.webp);"><span class="pill">SHOP NOW</span></div>
      </div>
    </section>
    <div class="dots" id="dots">
      <span class="dot active" data-i="0"></span>
      <span class="dot" data-i="1"></span>
      <span class="dot" data-i="2"></span>
    </div>
    <h2 class="section-title">Best Sellers</h2>
    <section class="grid" id="products"></section>
    <div class="load-more"><button id="loadMore">Load more</button></div>
  </main>

  <script>
    /* Slider */
    const slides = document.getElementById('slides');
    const dots = Array.from(document.querySelectorAll('#dots .dot'));
    let si = 0, sliderTimer;
    function goSlide(n){ si=(n + dots.length)%dots.length; slides.style.transform=`translateX(-${si*100}%)`; dots.forEach((d,idx)=>d.classList.toggle('active', idx===si));}
    function play(){ clearInterval(sliderTimer); sliderTimer=setInterval(()=>goSlide(si+1), 4000);}
    dots.forEach(d=>d.onclick=e=>{ goSlide(+e.target.dataset.i); play();}); play();

    /* =========================
       Covers via RAWG→Steam proxy
       FAST mode: parallel race + concurrency + lazy + CDN thumb
       ========================= */
    const PRIVATE_PROXY = ""; // e.g. "https://covers.yourname.workers.dev"
    const R2S_ORIGIN = "https://rawg2steam.phalco.de/api";

    // Speed knobs
    const COVER_TIMEOUT_MS = 2500;      // max wait per source
    const COVER_CONCURRENCY = 4;        // how many lookups at once
    const SKIP_COVERS = false;          // true = no remote cover fetches (placeholders only)

    const coverCache = JSON.parse(localStorage.getItem('dk_cover_cache') || '{}');
    const cachePut = (k,v)=>{ coverCache[k]=v; localStorage.setItem('dk_cover_cache', JSON.stringify(coverCache)); };

    function normTitle(s){
      return (s||"")
        .toLowerCase()
        .replace(/[®™:]/g,"")
        .replace(/[^a-z0-9 ]+/g," ")
        .replace(/\s+/g," ")
        .trim();
    }
    function pick(obj, keys){ for(const k of keys){ if(obj && obj[k]) return obj[k]; } return null; }
    function bestByTitle(results, want){
      let best=null, bestScore=-1;
      for(const item of results){
        const name = normTitle(item?.name || item?.title || "");
        let score=0; while(score<Math.min(name.length,want.length) && name[score]===want[score]) score++;
        if(score>bestScore){ best=item; bestScore=score; }
      }
      return best;
    }

    // Proxy any remote image through wsrv.nl to get a small, cached, CORS-clean WebP
    function thumbProxy(url){
      if(!url || url.startsWith('data:')) return url;
      return `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=300&h=400&fit=cover&output=webp`;
    }

    // ---- FAST fetch helpers (parallel race with timeout) ----
    function withTimeout(promise, ms) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), ms))
      ]);
    }
    function sourceUrlsFor(rawUrl) {
      const urls = [];
      if (PRIVATE_PROXY) urls.push(`${PRIVATE_PROXY}?url=${encodeURIComponent(rawUrl)}`);
      urls.push(rawUrl);
      urls.push(`https://cors.isomorphic-git.org/${rawUrl}`);
      urls.push(`https://corsproxy.io/?${encodeURIComponent(rawUrl)}`);
      urls.push(`https://thingproxy.freeboard.io/fetch/${rawUrl}`);
      const u = new URL(rawUrl);
      urls.push(`https://r.jina.ai/${u.protocol}//${u.host}${u.pathname}${u.search}`);
      return urls;
    }
    async function fetchJSONFast(rawUrl) {
      const urls = sourceUrlsFor(rawUrl);
      const attempts = urls.map(u =>
        withTimeout(
          fetch(u, { mode: "cors" })
            .then(res => { if (!res.ok) throw new Error("http " + res.status); return res.text(); })
            .then(txt => {
              const cleaned = txt.trim().replace(/^[^{\[]+/, "");
              return JSON.parse(cleaned);
            }),
          COVER_TIMEOUT_MS
        )
      );
      try {
        return await Promise.any(attempts);
      } catch {
        throw new Error("all cover sources failed");
      }
    }

    // ---- tiny concurrency gate ----
    let coverInFlight = 0;
    const coverQueue = [];
    function scheduleCover(taskFn) {
      return new Promise((resolve) => {
        coverQueue.push({ taskFn, resolve });
        runCoverQueue();
      });
    }
    function runCoverQueue() {
      while (coverInFlight < COVER_CONCURRENCY && coverQueue.length) {
        const { taskFn, resolve } = coverQueue.shift();
        coverInFlight++;
        taskFn()
          .then(resolve)
          .catch(()=>{}) // swallow; we keep placeholder
          .finally(()=>{ coverInFlight--; runCoverQueue(); });
      }
    }

    async function fetchCover(title) {
      if (SKIP_COVERS) return null;
      const q = encodeURIComponent(title);
      const url = `${R2S_ORIGIN}/games?search=${q}`;
      const data = await fetchJSONFast(url);
      const results = Array.isArray(data) ? data : (data?.results || []);
      if (!results.length) return null;

      const want = normTitle(title);
      const best = bestByTitle(results, want) || results[0];
      const img = pick(best, [
        "background_image","background_image_additional",
        "header_image","capsule_image","image","background",
      ]) || (best?.screenshots && best.screenshots[0]?.image) || (best?.images && best.images[0]) || null;

      return img || null;
    }

    async function maybeFetchCover(p){
      if (!p._needsCover || SKIP_COVERS) return;

      // Dedup by title across all platforms (incl. PC Offline)
      const reuseKey = p.title;

      if (coverCache[reuseKey]) {
        updateThumb(p.id, coverCache[reuseKey]);
        const offId = `${p.title.replace(/[^a-z0-9]/ig,'_')}_PC_OFFLINE`;
        updateThumb(offId, coverCache[reuseKey]);
        return;
      }

      await scheduleCover(async () => {
        const cover = await fetchCover(p.title);
        if (cover) {
          cachePut(reuseKey, cover);
          updateThumb(p.id, cover);
          const offId = `${p.title.replace(/[^a-z0-9]/ig,'_')}_PC_OFFLINE`;
          updateThumb(offId, cover);
        }
      });
    }

    function updateThumb(id, url){
      const img = document.querySelector(`[data-thumb-for="${id}"] img.cover`);
      if(img){ img.src = thumbProxy(url); }
      const card = img?.closest('.card');
      if(card){ card.dataset.img = thumbProxy(url); }
    }

    const COVER_PLACEHOLDER = "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='300' height='400'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0' stop-color='#3d3b7a'/><stop offset='1' stop-color='#1f1e4d'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/></svg>`);

    const TOP_200 = ["EA SPORTS FC 25","EA SPORTS FC 24","Battlefield 2042","Battlefield V","Battlefield 1","Call of Duty: Modern Warfare II (2022)","Call of Duty: Modern Warfare III (2023)","Hogwarts Legacy","Elden Ring","Baldur's Gate 3","Red Dead Redemption 2","Cyberpunk 2077","The Witcher 3: Wild Hunt","Forza Horizon 5","God of War Ragnarök","Ghost of Tsushima Director's Cut","Marvel’s Spider-Man 2","Starfield","Helldivers 2","Palworld"];
    const PLATFORMS = ["PC","PS5","Xbox","Switch"];
    function hash(s){ let h=0; for(let i=0;i<s.length;i++) h=(h<<5)-h + s.charCodeAt(i) | 0; return Math.abs(h); }
    function priceFor(name, platform){ const base = 2500 + (hash(name+platform)%6000); return Math.round(base/50)*50; }
    function discountFor(name){ const d=[0,10,12,15,18,20,22,25,30,35,40,45,50,55,60]; return d[hash(name)%d.length]; }

    const PRODUCTS = [];
    TOP_200.forEach(title=>{
      PLATFORMS.forEach(p=>{
        PRODUCTS.push({ id:`${title.replace(/[^a-z0-9]/ig,'_')}_${p}`, title, platform:p, name:`${title} (${p})`, price:priceFor(title,p), discount:discountFor(title), img:COVER_PLACEHOLDER, _needsCover:true });
        if(p==="PC"){ PRODUCTS.push({ id:`${title.replace(/[^a-z0-9]/ig,'_')}_PC_OFFLINE`, title, platform:"PC Offline", name:`${title} (PC Offline)`, price:1000, discount:0, img:COVER_PLACEHOLDER, _offlineOf:`${title}|PC`, _needsCover:true }); }
      });
    });

    const state = { q:"", platform:"All", pageSize:20, pageIndex:0, filtered:[] };
    const productsEl = document.getElementById('products');
    const loadMoreBtn = document.getElementById('loadMore');
    const tabsEl = document.getElementById('tabs');
    const searchEl = document.getElementById('searchInput');

    function platformMatch(p){ if(state.platform==="All") return true; if(state.platform==="PC") return p.platform.startsWith("PC"); return p.platform===state.platform; }

    // Lazy cover observer: start fetching a bit before visible
    const coverObserver = new IntersectionObserver((entries) => {
      entries.forEach(ent => {
        if (ent.isIntersecting) {
          const id = ent.target.getAttribute('data-thumb-for');
          const p = PRODUCTS.find(x => x.id === id);
          if (p) maybeFetchCover(p);
          coverObserver.unobserve(ent.target);
        }
      });
    }, { root: null, rootMargin: "200px" });

    function applyFilters(){
      const q = state.q.toLowerCase();
      state.filtered = PRODUCTS.filter(p=> platformMatch(p) && ((p.title + " " + p.platform).toLowerCase().includes(q)) );
      state.pageIndex = 0; productsEl.innerHTML = ""; renderNextPage();
    }
    function cardHTML(p){
      return `<article class="card" data-id="${p.id}" data-name="${p.name}" data-price="${p.price}" data-img="${thumbProxy(p.img)}">
        <div class="thumb" data-thumb-for="${p.id}">
          <img class="cover" src="${thumbProxy(p.img)}" alt="${p.title}" loading="lazy" decoding="async" referrerpolicy="no-referrer">
          <span class="platform" title="${p.platform}"></span>
          ${p.discount>0 ? `<span class="badge">${p.discount}% OFF</span>` : ``}
        </div>
        <div class="card-body">
          <h3 class="title">${p.title}</h3>
          <div class="sub">${p.platform}</div>
          <div class="price">${p.price.toLocaleString('en-DZ')} DA</div>
          <div class="actions"><button class="btn btn-add">Add to cart</button></div>
        </div>
      </article>`;
    }
    function renderNextPage(){
      const start = state.pageIndex * state.pageSize;
      const slice = state.filtered.slice(start, start + state.pageSize);
      productsEl.insertAdjacentHTML('beforeend', slice.map(cardHTML).join(''));
      state.pageIndex++;
      loadMoreBtn.style.display = state.pageIndex * state.pageSize < state.filtered.length ? 'inline-block' : 'none';
      // Observe thumbs for lazy cover fetching
      slice.forEach(p => {
        const el = document.querySelector(`[data-thumb-for="${p.id}"]`);
        if (el) coverObserver.observe(el);
      });
    }
    loadMoreBtn.onclick = renderNextPage;

    tabsEl.addEventListener('click', (e)=>{ const btn = e.target.closest('.tab'); if(!btn) return; tabsEl.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); state.platform = btn.dataset.platform; applyFilters(); });
    searchEl.addEventListener('input', ()=>{ state.q = searchEl.value.trim(); applyFilters(); });
    applyFilters();

    /* Cart */
    const cart = {
      items: [],
      add(p){const f=this.items.find(i=>i.id===p.id); if(f) f.qty++; else this.items.push({...p, qty:1}); this.save(); renderCart();},
      inc(id){const f=this.items.find(i=>i.id===id); if(f){f.qty++; this.save(); renderCart();}},
      dec(id){const f=this.items.find(i=>i.id===id); if(f){f.qty=Math.max(1,f.qty-1); this.save(); renderCart();}},
      remove(id){this.items=this.items.filter(i=>i.id!==id); this.save(); renderCart();},
      clear(){this.items=[]; this.save(); renderCart();},
      subtotal(){return this.items.reduce((s,i)=>s+i.price*i.qty,0);},
      save(){localStorage.setItem('dk_cart', JSON.stringify(this.items));},
      load(){this.items=JSON.parse(localStorage.getItem('dk_cart')||'[]');}
    };
    cart.load();

    const productsGrid = document.getElementById('products');
    productsGrid.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-add'); if(!btn) return;
      const card = e.target.closest('.card');
      const p = { id: card.dataset.id, name: card.dataset.name, price:+card.dataset.price, img: card.dataset.img };
      cart.add(p); openCartDrawer();
    });

    const cartDrawer = document.getElementById('cartDrawer');
    const openCartBtn = document.getElementById('openCart');
    const closeCartBtn = document.getElementById('closeCart');
    const menuDrawer = document.getElementById('menuDrawer');
    const openMenuBtn = document.getElementById('openMenu');
    const closeMenuBtn = document.getElementById('closeMenu');
    const backdrop = document.getElementById('backdrop');

    function openCartDrawer(){ cartDrawer.classList.add('open'); backdrop.classList.add('show'); }
    function closeCartDrawer(){ cartDrawer.classList.remove('open'); hideBackdropIfNone(); }
    function openMenuDrawer(){ menuDrawer.classList.add('open'); backdrop.classList.add('show'); }
    function closeMenuDrawer(){ menuDrawer.classList.remove('open'); hideBackdropIfNone(); }
    function hideBackdropIfNone(){
      if(!cartDrawer.classList.contains('open') && !menuDrawer.classList.contains('open')){
        backdrop.classList.remove('show');
      }
    }

    openCartBtn.onclick = openCartDrawer;
    closeCartBtn.onclick = closeCartDrawer;
    openMenuBtn.onclick = openMenuDrawer;
    closeMenuBtn.onclick = closeMenuDrawer;
    backdrop.onclick = ()=>{ closeCartDrawer(); closeMenuDrawer(); };

    const cartItemsEl = document.getElementById('cartItems');
    const subtotalEl = document.getElementById('subtotal');
    const feeLineEl = document.getElementById('feeLine');
    const feeValueEl = document.getElementById('feeValue');
    const grandEl = document.getElementById('grandTotal');
    const clearCartBtn = document.getElementById('clearCart');

    function money(n){ return `${n.toLocaleString('en-DZ')} DA`; }

    function renderCart(){
      cartItemsEl.innerHTML = cart.items.map(i=>`
        <div class="cart-item">
          <img src="${i.img}" alt="">
          <div>
            <div style="font-weight:600">${i.name}</div>
            <div class="qty">
              <button data-act="dec" data-id="${i.id}">−</button>
              <span>${i.qty}</span>
              <button data-act="inc" data-id="${i.id}">+</button>
              <button class="remove" data-act="rm" data-id="${i.id}">Remove</button>
            </div>
            <div class="small">${money(i.price)} each</div>
          </div>
          <div style="font-weight:600">${money(i.price*i.qty)}</div>
        </div>
      `).join('') || `<div class="small" style="opacity:.8">Your cart is empty.</div>`;

      const method = pm.value;
      const sub = cart.subtotal();
      let fee = 0;
      if(method === 'flexy'){ fee = Math.round(sub * 0.18); feeLineEl.style.display='flex'; }
      else { feeLineEl.style.display='none'; }
      subtotalEl.textContent = money(sub);
      feeValueEl.textContent = money(fee);
      grandEl.textContent = money(sub + fee);
    }

    cartItemsEl.addEventListener('click', (e)=>{
      const id = e.target.dataset.id; const act = e.target.dataset.act;
      if(!id || !act) return;
      if(act==='inc') cart.inc(id);
      if(act==='dec') cart.dec(id);
      if(act==='rm') cart.remove(id);
    });
    clearCartBtn.onclick = ()=> cart.clear();

    /* Payment info + toggles */
    const pm = document.getElementById('paymentMethod');
    const payInfo = document.getElementById('payInfo');
    const payInfoLabel = document.getElementById('payInfoLabel');
    const proofRow = document.getElementById('proofRow');
    const flexyExtraRows = document.getElementById('flexyExtraRows');

    const PAY_INFO = {
      baridimob: { label: 'BaridiMob RIB', html: '<b>007999990024562364</b>' },
      flexy:     { label: 'Flexy Number', html: '<b>0783700825</b>' },
      ccp:       { label: 'CCP Details', html: 'Clé: <b>53</b><br>Nom: <b>Faddy Neddar</b><br>RIB: <b>002542933</b>' }
    };

    function onPMChange(){
      const v = pm.value;
      payInfoLabel.textContent = PAY_INFO[v].label;
      payInfo.innerHTML = PAY_INFO[v].html;
      if(v==='flexy'){ flexyExtraRows.style.display='block'; proofRow.style.display='none'; }
      else { flexyExtraRows.style.display='none'; proofRow.style.display='block'; }
      renderCart();
    }
    pm.addEventListener('change', onPMChange);
    onPMChange();

    /* Submit (validate, then FormSubmit posts) */
    const orderForm = document.getElementById('orderForm');
    document.getElementById('sendOrder').addEventListener('click', ()=> orderForm.requestSubmit());
    orderForm.addEventListener('submit', (e)=>{
      const email = document.getElementById('contactEmail').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();
      const method = pm.value;

      if(cart.items.length===0){ e.preventDefault(); alert('Cart is empty.'); return; }
      if(!email && !phone){ e.preventDefault(); alert('Provide an email or a phone number.'); return; }

      if(method!=='flexy'){
        const proofInput = document.getElementById('proofFile');
        if(!proofInput.files || proofInput.files.length === 0){
          e.preventDefault(); alert('Please choose a payment proof (image or PDF).'); return;
        }
      } else {
        const flexyTime = document.getElementById('flexyTime').value;
        const flexyAmount = document.getElementById('flexyAmount').value;
        if(!flexyTime){ e.preventDefault(); alert('Enter the exact time of payment.'); return; }
        if(!flexyAmount){ e.preventDefault(); alert('Enter the exact amount paid.'); return; }
      }

      const itemsText = cart.items.map(i=>`${i.name} x${i.qty} — ${(i.price*i.qty).toLocaleString('en-DZ')} DA`).join('\n');
      const sub = cart.subtotal();
      const fee = (method==='flexy') ? Math.round(sub*0.18) : 0;
      const total = sub + fee;

      document.getElementById('f_items').value = itemsText;
      document.getElementById('f_subtotal').value = `${sub.toLocaleString('en-DZ')} DA`;
      document.getElementById('f_fee').value = fee ? `${fee.toLocaleString('en-DZ')} DA` : '0 DA';
      document.getElementById('f_total').value = `${total.toLocaleString('en-DZ')} DA`;
      document.getElementById('f_method').value = method.toUpperCase();
      document.getElementById('f_flexy_time').value = (method==='flexy') ? document.getElementById('flexyTime').value : '';
      document.getElementById('f_flexy_amount').value = (method==='flexy') ? `${document.getElementById('flexyAmount').value} DA` : '';
      document.getElementById('f_notes').value = document.getElementById('notes').value.trim();
    });
  </script>
</body> 
</html>
