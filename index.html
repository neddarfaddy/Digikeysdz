<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Digikeys</title>

  <!-- Fonts & Performance -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://wsrv.nl" crossorigin>

  <style>
    /* =========================================================
       THEME TOKENS
       ========================================================= */
    :root{
      --page-bg:#1b193b; --app-bg:#151437; --nav-bg:#2c2f66;
      --text:#fff; --muted:#a8adca; --accent:#00ff84;
      --chip-red:#ff4d5a; --card:#1d1c44; --card-hover:#24235a;
      --shadow:0 8px 24px rgba(0,0,0,.25); --radius:14px;
      --toast-bg:#0f102b; --toast-brd:#2a2b55;
    }

    /* =========================================================
       GLOBAL RESETS & BASE
       ========================================================= */
    html{
      scroll-behavior:smooth;
      background:var(--page-bg);
      overflow-x:hidden;
      background-color:#151437; /* explicit to avoid UA quirks */
      -webkit-text-size-adjust:100%;
    }
    *,*::before,*::after{ box-sizing:border-box }
    body{ margin:0; font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text) }
    a{ color:inherit; text-decoration:none }
    img{ display:block; max-width:100% }

    /* Visually-hidden utility (used in ✕ remove button) */
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* =========================================================
       HEADER / NAV
       ========================================================= */
    header{
      position:fixed; inset:0 0 auto 0; height:64px; z-index:50; background:var(--nav-bg);
      display:flex; align-items:center; padding:0 12px; box-shadow:0 2px 10px rgba(0,0,0,.25)
    }
    .nav{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; width:100% }
    .nav-left{ justify-self:start; display:flex; align-items:center; gap:12px }
    .nav-center{ justify-self:center; display:flex; align-items:center }
    .nav-right{ justify-self:end; display:flex; align-items:center; gap:10px }
    .hamburger{ width:28px; height:22px }
    .logo{ height:26px } /* bigger logo */

    .cart-link,.icon-btn, .lang-select{
      position:relative; background:transparent; border:none; padding:0; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center
    }
    .cart-link:focus,.icon-btn:focus{ outline:none }
    .cart-icon{ width:28px; height:28px }

    /* cart badge */
    .cart-badge{
      position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px;
      border-radius:999px; background:#ff4d5a; color:#fff; font-size:11px; line-height:18px;
      display:none; align-items:center; justify-content:center; font-weight:500; box-shadow:0 0 0 2px var(--nav-bg);
    }
    .cart-badge.show{ display:flex }

    /* language selector (compact) */
    .lang-wrap{ display:flex; align-items:center; gap:6px; }
    .lang-select{
      background:#20214a; color:#cfd2ff; border:1px solid #2a2b55; border-radius:10px; padding:6px 10px;
      font-size:12px;
    }

    /* =========================================================
       APP WRAPPER
       ========================================================= */
    .app{ margin:0 auto; background:var(--app-bg); min-height:100vh; padding:88px 16px 120px; max-width:430px }

    /* =========================================================
       SEARCH
       ========================================================= */
    .search-wrap{ margin-bottom:12px }
    .search{
      display:block; width:100%; max-width:100%; height:38px; border:none; border-radius:999px; /* shorter */
      padding:0 16px 0 40px; color:#131321; font-size:15px; -webkit-appearance:none; appearance:none;
      background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>') no-repeat 12px center;
      background-size:20px 20px;
    }

    /* =========================================================
       TABS
       ========================================================= */
    .tabs{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap }
    .tab{ padding:8px 12px; border-radius:999px; background:#20214a; color:#cfd2ff; border:1px solid #2a2b55; font-weight:500; font-size:12px }
    .tab.active{ background:var(--accent); color:#07101c; border-color:transparent }

    /* =========================================================
       HERO SLIDER (FULL-BLEED)
       ========================================================= */
    .hero{
      position:relative; overflow:hidden; border-radius:var(--radius); box-shadow:var(--shadow);
      aspect-ratio:16/9; margin:12px 0;
  border-radius:0 !important;

      /* full-bleed across viewport */
      width:100vw;
      left:50%; right:50%;
      margin-left:-50vw; margin-right:-50vw;
    }
    .slides{ display:flex; width:100%; height:100%; transition:transform .4s ease }
    .slide{ position:relative; min-width:100%; height:100%; background:#2a295d center/cover no-repeat }
    .pill{ position:absolute; left:16px; bottom:16px; background:var(--accent); color:#0a0f17; border-radius:0; padding:8px 14px; font-weight:500; font-size:12px; box-shadow:0 6px 16px rgba(0,255,132,.35) }
    .dots{ display:flex; gap:8px; justify-content:center; margin:12px 0 20px }
    .dot{ width:8px; height:8px; border-radius:50%; background:#4c4b86; opacity:.8 }
    .dot.active{ background:#24d07a; opacity:1 }

    /* =========================================================
       PRODUCT GRID & CARDS
       ========================================================= */
    .section-title{ font-size:28px; font-weight:700; margin:8px 0 12px }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px }

    .card{ background:var(--card); border-radius:16px; overflow:hidden; transition:transform .15s ease,background .15s ease }
    .card:hover{ transform:translateY(-2px); background:var(--card-hover) }

    .thumb{ position:relative; aspect-ratio:3/4; background:#262557; overflow:hidden; }
    .thumb img.cover{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:fill;        /* fit without stretching */
      object-position:center;
      display:block;
      background:#1a1a3a;
    }
    .badge{ position:absolute; right:8px; bottom:8px; background:var(--chip-red); color:#fff; font-weight:500; font-size:11px; padding:6px 8px; border-radius:999px }
    .platform{ position:absolute; left:8px; bottom:8px; width:18px; height:18px; border-radius:50%; background:#0008; border:1px solid #fff3 }

    .card-body{ padding:10px 12px 12px }
    .title{ font-size:12px; line-height:1.3; min-height:32px; font-weight:700; text-transform:uppercase }
    .sub{ font-size:11px; color:#bfc3ee; margin-top:2px; min-height:16px }
    .actions{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px }
    .btn{
      display:inline-flex; justify-content:center; align-items:center; height:36px; border-radius:4px; font-weight:500; cursor:pointer;
      text-transform:uppercase; border:1px solid transparent;
      transition:transform .08s ease, filter .1s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{ filter:brightness(1.03) }
    .btn-add{ background:transparent; color:#fff; border-color:#ffffff }
    .btn-buy{ background:#24d07a; color:#0b1320 }
    .btn-add:active,.btn-buy:active{ transform:translateY(1px) }

    .price{
      font-size:13px; color:#e7e9ff; margin-top:8px; padding-top:8px;
      border-top:1px solid #2a2b55;
    }

    /* =========================================================
       DRAWERS (Cart & Menu)
       ========================================================= */
    .drawer{ position:fixed; inset:0 0 0 auto; width:min(92vw,420px); background:#0f102b; transform:translateX(100%); transition:transform .25s ease; z-index:70; display:flex; flex-direction:column }
    .drawer.open{ transform:none }
    .drawer-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:#191a40; border-bottom:1px solid #2a2b55 }
    .drawer-title{ font-weight:500 }
    .drawer-body{ padding:14px 16px; overflow:auto; flex:1 }
    .drawer-foot{ padding:12px 16px; border-top:1px solid #2a2b55; background:#15163a; display:grid; gap:10px }
    .x{ background:none; border:none; color:#fff; font-size:20px; cursor:pointer }

    /* Cart items list */
    .cart-items{ display:grid; gap:10px; margin-bottom:14px }
    .cart-item img{ width:56px; height:56px; border-radius:8px; object-fit:cover; background:#2a295d }
    .cart-item{
      display:grid; grid-template-columns:56px 1fr auto; gap:10px; align-items:center;
      background:#161741; border-radius:12px; padding:8px; overflow:visible;
    }
    .qty{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; padding:2px; overflow:visible }
    .qty button{ width:32px; height:32px; border:none; border-radius:8px; background:#282a60; color:#fff; font-weight:500; cursor:pointer }

    /* ✕ Remove button (icon-only) */
    .remove{
      display:inline-flex; align-items:center; justify-content:center;
      width:32px; height:32px; border:none; border-radius:8px;
      background:#ff4d5a; color:#0b1320; font-weight:700; margin-left:8px; cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.2); position:relative; z-index:1;
    }
    .remove:hover{ filter:brightness(.95) }
    .remove:active{ transform:translateY(1px) }

    /* =========================================================
       FORM ELEMENTS
       ========================================================= */
    .row{ display:grid; gap:6px; margin:10px 0 }
    .label{ font-size:12px; color:var(--muted) }
    .input,.select,.textarea{
      width:100%; height:38px; border:1px solid #2a2b55; border-radius:10px;
      background:#0f102b; color:#fff; padding:0 12px; font-size:16px; -webkit-appearance:none; appearance:none;
    }
    .textarea{ height:72px; padding:8px 12px; resize:vertical }
    input[type="file"].input{ height:auto; padding:10px 12px; display:block; cursor:pointer }
    .info{ background:#11123a; border:1px solid #2a2b55; border-radius:10px; padding:10px 12px; font-size:13px; line-height:1.4; display:flex; justify-content:space-between; align-items:center; gap:10px }
    .info b{ font-weight:500 }
    .info .copy-btn{ height:30px; padding:0 10px; border:1px solid #2a2b55; border-radius:8px; background:#20214a; color:#cfd2ff; cursor:pointer; font-size:12px }
    .totals{ display:grid; gap:6px; margin:10px 0; font-size:14px }
    .totals .line{ display:flex; justify-content:space-between }
    .grand{ font-weight:500 }
    .hint{ font-size:12px; color:var(--muted) }
    .small{ font-size:11px; color:var(--muted) }

    /* =========================================================
       BACKDROP & MISC
       ========================================================= */
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:60 }
    .backdrop.show{ opacity:1; pointer-events:auto }

    .load-more{ margin:16px 0 24px; display:flex; justify-content:center }
    .load-more button{ background:#2a2b55; color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:500; cursor:pointer }

    /* Side menu */
    .menu{ position:fixed; inset:0 auto 0 0; width:min(86vw,360px); background:#13143a; transform:translateX(-100%); transition:transform .25s ease; z-index:70; display:flex; flex-direction:column; box-shadow:0 8px 24px rgba(0,0,0,.35) }
    .menu.open{ transform:none }
    .menu-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:#191a40; border-bottom:1px solid #2a2b55; font-weight:500 }
    .menu-body{ padding:12px 0; overflow:auto; flex:1 }
    .menu-title{ color:#a8adca; font-size:13px; padding:8px 16px 6px }
    .menu-item{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:14px 16px; background:transparent; color:#fff; border:none; text-align:left; cursor:pointer }
    .menu-item:hover{ background:#1b1c45 }
    .menu-item a{ color:inherit; text-decoration:none; flex:1 }
    .chev{ opacity:.7 }
    .sep{ height:1px; background:#2a2b55; margin:8px 16px }

    /* Primary button (sticky footer action) */
    .btn-primary{ height:42px; border:none; border-radius:2px; background:var(--accent); color:#07101c; font-weight:700; cursor:pointer; text-transform:uppercase }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:var(--toast-bg); border:1px solid var(--toast-brd); padding:10px 14px; border-radius:10px;
      font-size:13px; opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:90;
    }
    .toast.show{ opacity:1; }

    /* Footer */
    footer{ margin:20px 0 0; padding:16px; font-size:12px; color:#b8bcdf; text-align:center }
    footer .foot-row{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:8px }
    footer .lang-select{ padding:8px 12px }

    /* RTL tweaks */
    html[dir="rtl"] .nav{ grid-template-columns:1fr auto 1fr; }
    html[dir="rtl"] .menu{ inset:0 0 0 auto; transform:translateX(100%); }
    html[dir="rtl"] .menu.open{ transform:none; }
    html[dir="rtl"] .drawer{ inset:0 auto 0 0; transform:translateX(-100%); }
    html[dir="rtl"] .drawer.open{ transform:none; }
    html[dir="rtl"] .qty{ flex-direction:row-reverse }
    html[dir="rtl"] .info{ flex-direction:row-reverse }
  </style>
</head>

<body>
  <!-- Toast -->
  <div class="toast" id="toast">Copied</div>

  <!-- =======================================================
       TOP NAVBAR
       ======================================================= -->
  <header>
    <nav class="nav">
      <div class="nav-left">
        <button class="icon-btn" id="openMenu" aria-label="Open menu">
          <img class="hamburger" src="./imgs/hamburger.png" alt="">
        </button>
      </div>
      <div class="nav-center">
        <img class="logo" src="./imgs/Logo.png" alt="DIGIKEYS.">
      </div>
      <div class="nav-right">
        <!-- Language quick switch -->
        <div class="lang-wrap">
          <select class="lang-select" id="langSelectHeader" aria-label="Language">
            <option value="en">EN</option>
            <option value="fr">FR</option>
            <option value="ar">AR</option>
          </select>
        </div>
        <button class="cart-link" id="openCart" aria-label="Open cart">
          <img class="cart-icon" src="./imgs/shopping-cart.png" alt="Cart">
          <span class="cart-badge" id="cartBadge">0</span>
        </button>
      </div>
    </nav>
  </header>

  <!-- Global Backdrop for Drawers -->
  <div class="backdrop" id="backdrop"></div>

  <!-- =======================================================
       SIDE MENU DRAWER
       ======================================================= -->
  <aside class="menu" id="menuDrawer" aria-label="Main menu">
    <div class="menu-head">
      <span data-i18n="menu.title">Menu</span>
      <button class="x" id="closeMenu" aria-label="Close">✕</button>
    </div>
    <div class="menu-body">
      <div class="menu-group">
        <div class="menu-title" data-i18n="menu.connect">Connect</div>
        <a class="menu-item" href="https://www.instagram.com/digikeys_dz/" target="_blank" rel="noopener"><span>Instagram</span><span class="chev">›</span></a>
        <a class="menu-item" href="https://www.facebook.com/profile.php?id=61570530206331" target="_blank" rel="noopener"><span>Facebook</span><span class="chev">›</span></a>
        <a class="menu-item" href="mailto:digikeysdz@gmail.com"><span data-i18n="menu.email">Email</span><span class="chev">›</span></a>
      </div>
      <div class="sep"></div>
      <div class="menu-group">
        <div class="menu-title" data-i18n="menu.platforms">Platforms</div>
        <button class="menu-item" data-platform="PC"><span>PC</span><span class="chev">›</span></button>
        <button class="menu-item" data-platform="PS5"><span>PLAYSTATION</span><span class="chev">›</span></button>
        <button class="menu-item" data-platform="Xbox"><span>XBOX</span><span class="chev">›</span></button>
        <button class="menu-item" data-platform="Switch"><span>SWITCH</span><span class="chev">›</span></button>
      </div>
    </div>
  </aside>

  <!-- =======================================================
       CART DRAWER
       ======================================================= -->
  <aside class="drawer" id="cartDrawer" aria-label="Cart">
    <div class="drawer-head">
      <div class="drawer-title" data-i18n="cart.title">Your Cart</div>
      <button class="x" id="closeCart" aria-label="Close">✕</button>
    </div>

    <div class="drawer-body">
      <!-- Order form: posts to FormSubmit (no server) -->
      <form id="orderForm" method="POST" action="https://formsubmit.co/digikeysdz@gmail.com" enctype="multipart/form-data">
        <!-- FormSubmit config -->
        <input type="hidden" name="_subject" value="New Order - Digikeys">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_template" value="table">

        <!-- Dynamic cart items -->
        <div class="cart-items" id="cartItems"></div>

        <!-- Payment method & info -->
        <div class="row">
          <label class="label" for="paymentMethod" data-i18n="pay.method">Payment method</label>
          <select id="paymentMethod" name="payment_method_select" class="select">
            <option value="baridimob" data-i18n="pay.baridimob">BaridiMob</option>
            <option value="flexy" data-i18n="pay.flexy">Flexy (+18%)</option>
            <option value="ccp" data-i18n="pay.ccp">CCP</option>
          </select>
          <div class="hint" id="flexyHint" data-i18n="pay.flexyHint">Flexy adds an 18% service fee.</div>
        </div>

        <div class="row" id="payInfoRow">
          <div class="label" id="payInfoLabel">BaridiMob RIB</div>
          <div class="info" id="payInfo">
            <span id="payInfoValue"><b>007999990024562364</b></span>
            <button class="copy-btn" type="button" id="copyPayInfo" data-i18n="actions.copy">Copy</button>
          </div>
        </div>

        <!-- Proof upload (hidden for Flexy; required for others) -->
        <div id="proofRow">
          <div class="row">
            <label class="label" for="proofFile" data-i18n="pay.proofLabel">Payment proof (image or PDF)</label>
            <input id="proofFile" name="payment_proof" class="input" type="file" accept="image/*,.pdf"/>
          </div>
        </div>

        <!-- Extra Flexy fields -->
        <div id="flexyExtraRows" style="display:none;">
          <div class="row">
            <label class="label" for="flexyTime" data-i18n="pay.flexyTime">Exact time paid</label>
            <input id="flexyTime" class="input" type="datetime-local"/>
          </div>
          <div class="row">
            <label class="label" for="flexyAmount" data-i18n="pay.flexyAmount">Exact amount (DA)</label>
            <input id="flexyAmount" class="input" type="number" min="0" step="1" placeholder="e.g., 1500"/>
          </div>
        </div>

        <!-- Contact -->
        <div class="row">
          <label class="label" data-i18n="contact.label">Contact (email or phone)</label>
          <input id="contactEmail" name="email" class="input" type="email" placeholder="Email (optional)" data-i18n-ph="contact.emailPH"/>
          <input id="contactPhone" name="phone" class="input" type="tel" placeholder="Phone (optional)" data-i18n-ph="contact.phonePH"/>
          <div class="hint" data-i18n="contact.hint">At least one is required.</div>
        </div>

        <!-- Notes -->
        <div class="row">
          <label class="label" for="notes" data-i18n="notes.label">Notes (optional)</label>
          <textarea id="notes" name="notes" class="textarea" placeholder="Add any details for your order" data-i18n-ph="notes.ph"></textarea>
        </div>

        <!-- Totals -->
        <div class="totals">
          <div class="line"><span data-i18n="totals.subtotal">Subtotal</span><span id="subtotal">0 DA</span></div>
          <div class="line" id="feeLine" style="display:none;"><span data-i18n="totals.fee">Flexy fee (18%)</span><span id="feeValue">0 DA</span></div>
          <div class="line grand"><span data-i18n="totals.total">Total</span><span id="grandTotal">0 DA</span></div>
        </div>
        <p class="small" data-i18n="orders.sentTo">Orders are sent to <strong>digikeysdz@gmail.com</strong>. You’ll receive a confirmation reply.</p>

        <!-- Hidden fields (sent to email) -->
        <input type="hidden" name="items" id="f_items">
        <input type="hidden" name="subtotal_pretty" id="f_subtotal">
        <input type="hidden" name="fee_pretty" id="f_fee">
        <input type="hidden" name="total_pretty" id="f_total">
        <input type="hidden" name="payment_method" id="f_method">
        <input type="hidden" name="flexy_time" id="f_flexy_time">
        <input type="hidden" name="flexy_amount" id="f_flexy_amount">
        <input type="hidden" name="notes_copy" id="f_notes">
      </form>
    </div>

    <!-- Sticky footer actions -->
    <div class="drawer-foot">
      <button class="btn-primary" id="sendOrder" type="submit" form="orderForm" data-i18n="actions.send">Send Order</button>
      <button class="btn" id="clearCart" type="button" style="background:#2a2b55;color:#fff;" data-i18n="actions.clear">Clear Cart</button>
    </div>
  </aside>

  <!-- =======================================================
       MAIN CONTENT
       ======================================================= -->
  <main class="app">
    <!-- Search -->
    <div class="search-wrap">
      <input class="search" id="searchInput" type="search" placeholder="Search by title..." data-i18n-ph="search.ph"/>
    </div>

    <!-- Hero (full-bleed) -->
    <section class="hero" aria-label="Featured">
      <div class="slides" id="slides">
        <div class="slide" style="background-image:url(./imgs/Silksong_desktop.webp);"><span class="pill" data-i18n="hero.new">NEW RELEASE</span></div>
        <div class="slide" style="background-image:url(./imgs/Helldivers.webp);"><span class="pill" data-i18n="hero.hot">HOT DEAL</span></div>
        <div class="slide" style="background-image:url(./imgs/MetalGearSnakeEater.webp);"><span class="pill" data-i18n="hero.shop">SHOP NOW</span></div>
      </div>
    </section>
    <div class="dots" id="dots">
      <span class="dot active" data-i="0"></span>
      <span class="dot" data-i="1"></span>
      <span class="dot" data-i="2"></span>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-platform="All" data-i18n="tabs.all">All</button>
      <button class="tab" data-platform="PC">PC</button>
      <button class="tab" data-platform="PS5">PS5</button>
      <button class="tab" data-platform="Xbox">Xbox</button>
      <button class="tab" data-platform="Switch">Switch</button>
    </div>

    <!-- Best Sellers -->
    <h2 class="section-title" data-i18n="sections.best">Best Sellers</h2>
    <section class="grid" id="products"></section>
    <div class="load-more"><button id="loadMore" data-i18n="actions.loadMore">Load more</button></div>
  </main>

  <!-- =======================================================
       FOOTER
       ======================================================= -->
  <footer>
    <div id="copyright">© <span id="year"></span> Digikeys. <span data-i18n="rights">All rights reserved.</span></div>
    <div class="foot-row">
      <span data-i18n="footer.language">Language:</span>
      <select class="lang-select" id="langSelectFooter" aria-label="Language (footer)">
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="ar">العربية</option>
      </select>
    </div>
  </footer>

  <script>
    /* =========================================================
       HERO SLIDER (RTL-aware)
       ========================================================= */
    const slides = document.getElementById('slides');
    const dots = Array.from(document.querySelectorAll('#dots .dot'));
    let si = 0, sliderTimer;

    function goSlide(n){
      si = (n + dots.length) % dots.length;
      const isRTL = document.documentElement.dir === 'rtl';
      slides.style.transform = `translateX(${isRTL ? (si*100) : (-si*100)}%)`;
      dots.forEach((d,idx)=>d.classList.toggle('active', idx===si));
    }
    function play(){ clearInterval(sliderTimer); sliderTimer = setInterval(()=>goSlide(si+1), 4000); }
    dots.forEach(d=>d.onclick=e=>{ goSlide(+e.target.dataset.i); play(); });
    play();

    /* =========================================================
       I18N SETUP (EN / FR / AR)
       ========================================================= */
    const I18N = {
      en: {
        'menu.title':'Menu','menu.connect':'Connect','menu.platforms':'Platforms','menu.email':'Email',
        'cart.title':'Your Cart',
        'pay.method':'Payment method','pay.baridimob':'BaridiMob','pay.flexy':'Flexy (+18%)','pay.ccp':'CCP',
        'pay.flexyHint':'Flexy adds an 18% service fee.',
        'pay.proofLabel':'Payment proof (image or PDF)',
        'pay.flexyTime':'Exact time paid','pay.flexyAmount':'Exact amount (DA)',
        'contact.label':'Contact (email or phone)','contact.hint':'At least one is required.',
        'contact.emailPH':'Email (optional)','contact.phonePH':'Phone (optional)',
        'notes.label':'Notes (optional)','notes.ph':'Add any details for your order',
        'totals.subtotal':'Subtotal','totals.fee':'Flexy fee (18%)','totals.total':'Total',
        'orders.sentTo':'Orders are sent to <strong>digikeysdz@gmail.com</strong>. You’ll receive a confirmation reply.',
        'actions.send':'Send Order','actions.clear':'Clear Cart','actions.loadMore':'Load more','actions.copy':'Copy',
        'actions.add':'Add to cart','actions.buy':'Buy now',
        'hero.new':'NEW RELEASE','hero.hot':'HOT DEAL','hero.shop':'SHOP NOW',
        'sections.best':'Best Sellers',
        'tabs.all':'All',
        'search.ph':'Search by title...',
        'rights':'All rights reserved.',
        'footer.language':'Language:',
        'payinfo.baridimob.label':'BaridiMob RIB',
        'payinfo.baridimob.value':'<b>007999990024562364</b>',
        'payinfo.flexy.label':'Flexy Number',
        'payinfo.flexy.value':'<b>0783700825</b>',
        'payinfo.ccp.label':'CCP Details',
        'payinfo.ccp.value':'Clé: <b>53</b><br>Nom: <b>Faddy Neddar</b><br>RIB: <b>002542933</b>',
        'toast.copied':'Copied'
      },
      fr: {
        'menu.title':'Menu','menu.connect':'Réseaux','menu.platforms':'Plateformes','menu.email':'E-mail',
        'cart.title':'Votre panier',
        'pay.method':'Mode de paiement','pay.baridimob':'BaridiMob','pay.flexy':'Flexy (+18%)','pay.ccp':'CCP',
        'pay.flexyHint':"Flexy ajoute des frais de service de 18 %.",
        'pay.proofLabel':'Preuve de paiement (image ou PDF)',
        'pay.flexyTime':'Heure exacte du paiement','pay.flexyAmount':'Montant exact (DA)',
        'contact.label':'Contact (e-mail ou téléphone)','contact.hint':'Au moins un champ est requis.',
        'contact.emailPH':'E-mail (optionnel)','contact.phonePH':'Téléphone (optionnel)',
        'notes.label':'Notes (optionnel)','notes.ph':'Ajoutez des détails pour votre commande',
        'totals.subtotal':'Sous-total','totals.fee':'Frais Flexy (18 %)','totals.total':'Total',
        'orders.sentTo':'Les commandes sont envoyées à <strong>digikeysdz@gmail.com</strong>. Vous recevrez une confirmation.',
        'actions.send':'Envoyer la commande','actions.clear':'Vider le panier','actions.loadMore':'Afficher plus','actions.copy':'Copier',
        'actions.add':'Ajouter au panier','actions.buy':'Acheter',
        'hero.new':'NOUVEAUTÉ','hero.hot':'BON PLAN','hero.shop':'ACHETER',
        'sections.best':'Meilleures ventes',
        'tabs.all':'Tous',
        'search.ph':'Rechercher par titre…',
        'rights':'Tous droits réservés.',
        'footer.language':'Langue :',
        'payinfo.baridimob.label':'RIB BaridiMob',
        'payinfo.baridimob.value':'<b>007999990024562364</b>',
        'payinfo.flexy.label':'Numéro Flexy',
        'payinfo.flexy.value':'<b>0783700825</b>',
        'payinfo.ccp.label':'Détails CCP',
        'payinfo.ccp.value':'Clé : <b>53</b><br>Nom : <b>Faddy Neddar</b><br>RIB : <b>002542933</b>',
        'toast.copied':'Copié'
      },
      ar: {
        'menu.title':'القائمة','menu.connect':'تواصل','menu.platforms':'المنصّات','menu.email':'البريد',
        'cart.title':'سلة المشتريات',
        'pay.method':'طريقة الدفع','pay.baridimob':'بريدي موب','pay.flexy':'فليكسي (+18%)','pay.ccp':'الحساب البريدي',
        'pay.flexyHint':'فليكسي يضيف عمولة خدمة 18٪.',
        'pay.proofLabel':'إثبات الدفع (صورة أو PDF)',
        'pay.flexyTime':'وقت الدفع بدقة','pay.flexyAmount':'المبلغ بالدينار (DA)',
        'contact.label':'وسيلة تواصل (إيميل أو هاتف)','contact.hint':'يُطلب إدخال واحد على الأقل.',
        'contact.emailPH':'الإيميل (اختياري)','contact.phonePH':'الهاتف (اختياري)',
        'notes.label':'ملاحظات (اختياري)','notes.ph':'أضف تفاصيل تخص طلبك',
        'totals.subtotal':'المجموع الفرعي','totals.fee':'رسوم فليكسي (18٪)','totals.total':'الإجمالي',
        'orders.sentTo':'تُرسل الطلبات إلى <strong>digikeysdz@gmail.com</strong> وسيصلكم تأكيد.',
        'actions.send':'إرسال الطلب','actions.clear':'تفريغ السلة','actions.loadMore':'عرض المزيد','actions.copy':'نسخ',
        'actions.add':'أضِف إلى السلة','actions.buy':'اشتري الآن',
        'hero.new':'إصدار جديد','hero.hot':'عرض مميّز','hero.shop':'تسوّق الآن',
        'sections.best':'الأكثر مبيعًا',
        'tabs.all':'الكل',
        'search.ph':'ابحث بالعنوان…',
        'rights':'جميع الحقوق محفوظة.',
        'footer.language':'اللغة:',
        'payinfo.baridimob.label':'رقم RIB لبريدي موب',
        'payinfo.baridimob.value':'<b>007999990024562364</b>',
        'payinfo.flexy.label':'رقم فليكسي',
        'payinfo.flexy.value':'<b>0783700825</b>',
        'payinfo.ccp.label':'تفاصيل CCP',
        'payinfo.ccp.value':'المفتاح: <b>53</b><br>الاسم: <b>Faddy Neddar</b><br>RIB: <b>002542933</b>',
        'toast.copied':'تم النسخ'
      }
    };

    function setLang(lang){
      const dict = I18N[lang] || I18N.en;
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang==='ar') ? 'rtl' : 'ltr';

      // text nodes
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if(dict[k]) el.innerHTML = dict[k];
      });
      // placeholders
      document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
        const k = el.getAttribute('data-i18n-ph');
        if(dict[k]) el.setAttribute('placeholder', dict[k]);
      });

      // Payment info area according to current method
      updatePayInfo();

      // Sync selects
      langSelectHeader.value = lang;
      langSelectFooter.value = lang;

      // Toast text
      toastText = dict['toast.copied'] || 'Copied';

      // Re-translate any newly injected product buttons
      document.querySelectorAll('.btn-add[data-i18n], .btn-buy[data-i18n]').forEach(btn=>{
        const k = btn.getAttribute('data-i18n');
        if(dict[k]) btn.textContent = dict[k];
      });
    }

    const langSelectHeader = document.getElementById('langSelectHeader');
    const langSelectFooter = document.getElementById('langSelectFooter');

    /* =========================================================
       MANUAL METADATA (Covers + Prices + Discounts)
       ========================================================= */
    const COVERS = {
      "Elden Ring": "./imgs/covers/elden_ring_pc.webp",
      "EA Sports FC 25": "./imgs/covers/fc25Cover.webp",
      "Elden Ring: Nightreign": "./imgs/covers/elden_ring_nightreign_pc.webp",
      "GTA 5": "./imgs/covers/gta_v_enhanced_cdkeys.webp",
      // Add more as you save them locally...
    };

    const PRICE_OVERRIDES = { /* optional per-title or per-title|platform */ };
    const DISCOUNT_OVERRIDES = { /* optional per-title or per-title|platform */ };

    /* Image helpers */
    function thumbProxy(url){
      if (!url || url.startsWith('data:')) return url;
      if (!/^https?:\/\//i.test(url)) return url;   // local path => don't proxy
      return `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=300&h=400&fit=contain&output=webp`;
    }

    const COVER_PLACEHOLDER =
      "data:image/svg+xml;utf8," +
      encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='300' height='400'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0' stop-color='#3d3b7a'/><stop offset='1' stop-color='#1f1e4d'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/></svg>`);

    function coverFor(title){
      const src = COVERS[title];
      if (!src) console.warn(`[COVERS] Missing cover for: "${title}"`);
      return thumbProxy(src || COVER_PLACEHOLDER);
    }

    /* =========================================================
       TITLES SOURCE (subset shown here; keep your full list)
       ========================================================= */
    const TITLE_BASE = `
Elden Ring|Elden Ring: Nightreign|Baldur’s Gate 3|Cyberpunk 2077|Red Dead Redemption 2|GTA 5|
The Witcher 3: Wild Hunt|Assassin’s Creed Shadows|Mafia: The Old Country|Metal Gear Solid Δ: Snake Eater|
Doom: The Dark Ages|The Elder Scrolls IV: Oblivion Remastered|
Death Stranding 2: On the Beach|
Monster Hunter Wilds|God of War Ragnarök|Marvel’s Spider-Man 2|The Last of Us Part I|The Last of Us Part II
|Horizon Forbidden West|Ghost of Tsushima Director’s Cut|Starfield|Palworld|Borderlands 4|Kingdom Come Deliverance 2
|Hollow Knight: Silksong|Helldivers 2|Hogwarts Legacy|Alan Wake II|Resident Evil 4 (Remake)|Resident Evil Village|
Final Fantasy VII Rebirth|Persona 3 Reload|Like a Dragon: Infinite Wealth|Sekiro: Shadows Die Twice|Bloodborne|
Demon’s Souls (Remake)|Dark Souls III|Nioh 2|Wo Long: Fallen Dynasty|Batman: Arkham Knight|
Suicide Squad: Kill the Justice League|Star Wars Jedi: Survivor|Diablo IV|VALORANT|
Counter-Strike 2|Overwatch 2|Apex Legends|Destiny 2|Call of Duty: Black Ops 6 (2024)|EA Sports FC 25|
Mario Kart World|The Legend of Zelda: Tears of the Kingdom|The Legend of Zelda: Breath of the Wild|Super Smash Bros. Ultimate|Super Mario Odyssey|Animal Crossing: New Horizons
`.trim();

    /* =========================================================
       PRODUCT FABRICATION (Price/Discount/Images)
       ========================================================= */
    const PLATFORMS = ["PC","PS5","Xbox","Switch"];

    function hash(s){ let h=0; for(let i=0;i<s.length;i++) h=(h<<5)-h + s.charCodeAt(i) | 0; return Math.abs(h); }

    function priceAuto(title, platform){
      const base = 2500 + (hash(title + platform) % 6000); // 2500 - 8500
      return Math.round(base/50)*50; // 50 DA steps
    }

    function priceFor(title, platform){
      if (platform === "PC Offline") return 1000;     // force 1000 DA for offline
      const keyPlatform = `${title}|${platform}`;
      if(PRICE_OVERRIDES.hasOwnProperty(keyPlatform)) return PRICE_OVERRIDES[keyPlatform];
      if(PRICE_OVERRIDES.hasOwnProperty(title)) return PRICE_OVERRIDES[title];
      return priceAuto(title, platform);
    }

    function discountFor(title, platform){
      const keyPlatform = `${title}|${platform}`;
      if(DISCOUNT_OVERRIDES.hasOwnProperty(keyPlatform)) return DISCOUNT_OVERRIDES[keyPlatform];
      if(DISCOUNT_OVERRIDES.hasOwnProperty(title)) return DISCOUNT_OVERRIDES[title];
      const d=[0,10,12,15,18,20,22,25,30,35,40,45,50,55,60];
      return d[hash(title)%d.length];
    }

    const titles = TITLE_BASE.split('|').map(s=>s.trim()).filter(Boolean);
    for(let y=2015; y<=2023; y++) titles.push(`FIFA ${y}`);
    for(let y=2017; y<=2025; y++) titles.push(`NBA 2K${y}`);
    for(let y=2018; y<=2025; y++) titles.push(`Madden NFL ${y}`);
    for(let y=2016; y<=2024; y++) titles.push(`F1 ${y}`);
    for(let y=2018; y<=2024; y++) titles.push(`WWE 2K${y}`);
    for(let y=2018; y<=2024; y++) titles.push(`NHL ${y}`);
    for(let y=2018; y<=2024; y++) titles.push(`MLB The Show ${y}`);
    titles.push("Call of Duty: Modern Warfare (2019)","Call of Duty: Black Ops 6 (2024)");
    const TITLES = Array.from(new Set(titles));

    const PRODUCTS = [];
    TITLES.forEach(title=>{
      PLATFORMS.forEach(p=>{
        PRODUCTS.push({
          id:`${title.replace(/[^a-z0-9]/ig,'_')}_${p}`,
          title, platform:p, name:`${title} (${p})`,
          price:priceFor(title,p),
          discount:discountFor(title,p),
          img: coverFor(title)
        });
        if(p==="PC"){
          PRODUCTS.push({
            id:`${title.replace(/[^a-z0-9]/ig,'_')}_PC_OFFLINE`,
            title, platform:"PC Offline", name:`${title} (PC Offline)`,
            price:priceFor(title,"PC Offline"),
            discount:discountFor(title,"PC Offline"),
            img: coverFor(title),
            _offlineOf:`${title}|PC`
          });
        }
      });
    });

    /* =========================================================
       SEARCH & FILTERING
       ========================================================= */
    const rmDiacritics = s => s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
    const norm = s => rmDiacritics(s.toLowerCase().replace(/[^a-z0-9\s]/gi,' ')).replace(/\s+/g,' ').trim();

    function editDistance(a,b){
      const al=a.length, bl=b.length;
      if(al===0) return bl; if(bl===0) return al;
      const dp=Array.from({length:al+1},()=>Array(bl+1).fill(0));
      for(let i=0;i<=al;i++) dp[i][0]=i;
      for(let j=0;j<=bl;j++) dp[0][j]=j;
      for(let i=1;i<=al;i++){
        for(let j=1;j<=bl;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
          if(i>1 && j>1 && a[i-1]===b[j-2] && a[i-2]===b[j-1]){
            dp[i][j] = Math.min(dp[i][j], dp[i-2][j-2]+cost);
          }
        }
      }
      return dp[al][bl];
    }

    function forgivingMatch(product, query){
      if(!query) return true;
      const q = norm(query);
      if(!q) return true;
      const hay = norm(product.title + ' ' + product.platform);
      if(hay.includes(q)) return true;
      const qTokens = q.split(' ');
      const hayTokens = hay.split(' ');
      return qTokens.every(qt=>{
        if(hay.includes(qt)) return true;
        for(const ht of hayTokens){
          if(Math.abs(ht.length-qt.length) > 2) continue;
          if(editDistance(ht, qt) <= 2) return true;
          let i=0,j=0; while(i<qt.length && j<ht.length){ if(qt[i]===ht[j++]) i++; }
          if(i>=qt.length-1 && qt.length>2) return true;
        }
        return false;
      });
    }

    const state = { q:"", platform:"All", pageSize:20, pageIndex:0, filtered:[] };
    const productsEl = document.getElementById('products');
    const loadMoreBtn = document.getElementById('loadMore');
    const tabsEl = document.getElementById('tabs');
    const searchEl = document.getElementById('searchInput');

    function platformMatch(p){
      if(state.platform==="All") return true;
      if(state.platform==="PC") return p.platform.startsWith("PC");
      return p.platform===state.platform;
    }

    function applyFilters(){
      const q = state.q;
      state.filtered = PRODUCTS.filter(p=> platformMatch(p) && forgivingMatch(p, q) );
      state.pageIndex = 0;
      productsEl.innerHTML = "";
      renderNextPage();
    }

    function money(n){ return `${n.toLocaleString('en-DZ')} DA`; }

    function cardHTML(p){
      return `<article class="card" data-id="${p.id}" data-name="${p.name}" data-price="${p.price}" data-img="${p.img}">
        <div class="thumb" data-thumb-for="${p.id}">
          <img class="cover"
               src="${p.img}"
               alt="${p.title}"
               loading="lazy"
               decoding="async"
               referrerpolicy="no-referrer"
               onerror="this.onerror=null; this.src='${COVER_PLACEHOLDER}';">
          <span class="platform" title="${p.platform}"></span>
          ${p.discount>0 ? `<span class="badge">${p.discount}% OFF</span>` : ``}
        </div>
        <div class="card-body">
          <h3 class="title">${p.title}</h3>
          <div class="sub">${p.platform}</div>
          <div class="price">${money(p.price)}</div>
          <div class="actions">
            <button class="btn btn-add" data-i18n="actions.add">Add to cart</button>
            <button class="btn btn-buy" data-i18n="actions.buy">Buy now</button>
          </div>
        </div>
      </article>`;
    }

    function renderNextPage(){
      const start = state.pageIndex * state.pageSize;
      const slice = state.filtered.slice(start, start + state.pageSize);
      productsEl.insertAdjacentHTML('beforeend', slice.map(cardHTML).join(''));
      state.pageIndex++;
      loadMoreBtn.style.display = state.pageIndex * state.pageSize < state.filtered.length ? 'inline-block' : 'none';
      setLang(currentLang); // translate newly injected buttons
    }
    loadMoreBtn.onclick = renderNextPage;

    tabsEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab'); if(!btn) return;
      tabsEl.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active'); state.platform = btn.dataset.platform; applyFilters();
    });
    searchEl.addEventListener('input', ()=>{ state.q = searchEl.value.trim(); applyFilters(); });

    /* Side menu → filter and sync tabs */
    document.querySelectorAll('.menu-item[data-platform]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const plat = btn.getAttribute('data-platform');
        state.platform = plat;
        document.querySelectorAll('#tabs .tab').forEach(t=>{
          t.classList.toggle('active', t.dataset.platform === plat || (plat==='All' && t.dataset.platform==='All'));
        });
        applyFilters();
        document.getElementById('menuDrawer').classList.remove('open');
        document.getElementById('backdrop').classList.remove('show');
      });
    });

    /* =========================================================
       CART MODEL & PERSISTENCE
       ========================================================= */
    const cart = {
      items: [],
      add(p){ const f=this.items.find(i=>i.id===p.id); if(f) f.qty++; else this.items.push({...p, qty:1}); this.save(); renderCart(); updateBadge(); },
      inc(id){ const f=this.items.find(i=>i.id===id); if(f){ f.qty++; this.save(); renderCart(); updateBadge(); } },
      dec(id){ const f=this.items.find(i=>i.id===id); if(f){ f.qty=Math.max(1,f.qty-1); this.save(); renderCart(); updateBadge(); } },
      remove(id){ this.items=this.items.filter(i=>i.id!==id); this.save(); renderCart(); updateBadge(); },
      clear(){ this.items=[]; this.save(); renderCart(); updateBadge(); },
      subtotal(){ return this.items.reduce((s,i)=>s+i.price*i.qty,0); },
      count(){ return this.items.reduce((s,i)=>s+i.qty,0); },
      save(){ localStorage.setItem('dk_cart', JSON.stringify(this.items)); },
      load(){ this.items=JSON.parse(localStorage.getItem('dk_cart')||'[]'); }
    };
    cart.load();

    // Grid actions (Add / Buy)
    const productsGrid = document.getElementById('products');
    productsGrid.addEventListener('click', (e)=>{
      const addBtn = e.target.closest('.btn-add');
      const buyBtn = e.target.closest('.btn-buy');
      if(!addBtn && !buyBtn) return;

      const card = e.target.closest('.card');
      const p = { id: card.dataset.id, name: card.dataset.name, price:+card.dataset.price, img: card.dataset.img };

      cart.add(p);
      if(buyBtn) openCartDrawer(); // Buy now opens cart
    });

    /* =========================================================
       DRAWER WIRING (Cart + Menu + Backdrop)
       ========================================================= */
    const cartDrawer = document.getElementById('cartDrawer');
    const openCartBtn = document.getElementById('openCart');
    const closeCartBtn = document.getElementById('closeCart');
    const menuDrawer = document.getElementById('menuDrawer');
    const openMenuBtn = document.getElementById('openMenu');
    const closeMenuBtn = document.getElementById('closeMenu');
    const backdrop = document.getElementById('backdrop');

    function openCartDrawer(){ cartDrawer.classList.add('open'); backdrop.classList.add('show'); }
    function closeCartDrawer(){ cartDrawer.classList.remove('open'); hideBackdropIfNone(); }
    function openMenuDrawer(){ menuDrawer.classList.add('open'); backdrop.classList.add('show'); }
    function closeMenuDrawer(){ menuDrawer.classList.remove('open'); hideBackdropIfNone(); }
    function hideBackdropIfNone(){
      if(!cartDrawer.classList.contains('open') && !menuDrawer.classList.contains('open')){
        backdrop.classList.remove('show');
      }
    }

    openCartBtn.onclick = openCartDrawer;
    closeCartBtn.onclick = closeCartDrawer;
    openMenuBtn.onclick = openMenuDrawer;
    closeMenuBtn.onclick = closeMenuDrawer;
    backdrop.onclick = ()=>{ closeCartDrawer(); closeMenuDrawer(); };

    /* =========================================================
       CART RENDERING & TOTALS
       ========================================================= */
    const cartItemsEl = document.getElementById('cartItems');
    const subtotalEl = document.getElementById('subtotal');
    const feeLineEl = document.getElementById('feeLine');
    const feeValueEl = document.getElementById('feeValue');
    const grandEl = document.getElementById('grandTotal');
    const clearCartBtn = document.getElementById('clearCart');
    const cartBadge = document.getElementById('cartBadge');

    function renderCart(){
      cartItemsEl.innerHTML = cart.items.map(i=>`
        <div class="cart-item">
          <img src="${i.img}" alt="">
          <div>
            <div style="font-weight:500">${i.name}</div>
            <div class="qty">
              <button data-act="dec" data-id="${i.id}" aria-label="Decrease quantity">−</button>
              <span>${i.qty}</span>
              <button data-act="inc" data-id="${i.id}" aria-label="Increase quantity">+</button>
              <button class="remove" data-act="rm" data-id="${i.id}" aria-label="Remove item">
                <span aria-hidden="true">✕</span><span class="sr-only">Remove</span>
              </button>
            </div>
            <div class="small">${money(i.price)} each</div>
          </div>
          <div style="font-weight:500;text-align:right">${money(i.price*i.qty)}</div>
        </div>
      `).join('') || `<div class="small" style="opacity:.8">${currentLang==='ar' ? 'سلتك فارغة.' : (currentLang==='fr'?'Votre panier est vide.':'Your cart is empty.')}</div>`;

      const method = pm.value;
      const sub = cart.subtotal();
      let fee = 0;
      if(method === 'flexy'){ fee = Math.round(sub * 0.18); feeLineEl.style.display='flex'; }
      else { feeLineEl.style.display='none'; }
      subtotalEl.textContent = money(sub);
      feeValueEl.textContent = money(fee);
      grandEl.textContent = money(sub + fee);
    }

    function updateBadge(){
      const n = cart.count();
      if(n>0){ cartBadge.textContent = n>99 ? '99+' : n; cartBadge.classList.add('show'); }
      else { cartBadge.classList.remove('show'); }
    }

    cartItemsEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const { id, act } = btn.dataset;
      if(!id || !act) return;
      if(act==='inc') cart.inc(id);
      if(act==='dec') cart.dec(id);
      if(act==='rm') cart.remove(id);
    });
    clearCartBtn.onclick = ()=> cart.clear();

    /* =========================================================
       PAYMENT INFO & UI TOGGLES + COPY BUTTON
       ========================================================= */
    const pm = document.getElementById('paymentMethod');
    const payInfo = document.getElementById('payInfo');
    const payInfoLabel = document.getElementById('payInfoLabel');
    const payInfoValue = document.getElementById('payInfoValue');
    const copyPayInfo = document.getElementById('copyPayInfo');
    const proofRow = document.getElementById('proofRow');
    const flexyExtraRows = document.getElementById('flexyExtraRows');
    const toast = document.getElementById('toast');
    let toastText = 'Copied';

    const PAY_INFO = {
      baridimob: { labelKey: 'payinfo.baridimob.label', valueKey:'payinfo.baridimob.value', raw:'007999990024562364' },
      flexy:     { labelKey: 'payinfo.flexy.label',     valueKey:'payinfo.flexy.value',     raw:'0783700825' },
      ccp:       { labelKey: 'payinfo.ccp.label',       valueKey:'payinfo.ccp.value',       raw:'53 / Faddy Neddar / 002542933' }
    };

    function updatePayInfo(){
      const v = pm.value;
      const dict = I18N[currentLang] || I18N.en;
      const meta = PAY_INFO[v];
      payInfoLabel.textContent = dict[meta.labelKey];
      payInfoValue.innerHTML = dict[meta.valueKey];
      if(v==='flexy'){ flexyExtraRows.style.display='block'; proofRow.style.display='none'; }
      else { flexyExtraRows.style.display='none'; proofRow.style.display='block'; }
    }

    function showToast(msg){
      toast.textContent = msg || toastText;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1400);
    }

    copyPayInfo.addEventListener('click', ()=>{
      const v = pm.value;
      const raw = PAY_INFO[v].raw;
      navigator.clipboard.writeText(raw).then(()=> showToast(), ()=> showToast());
    });

    function onPMChange(){
      updatePayInfo();
      renderCart(); // recalc totals (fee)
    }
    pm.addEventListener('change', onPMChange);

    /* =========================================================
       SUBMIT: VALIDATION + HIDDEN FIELDS
       ========================================================= */
    const orderForm = document.getElementById('orderForm');
    document.getElementById('sendOrder').addEventListener('click', ()=> orderForm.requestSubmit());

    orderForm.addEventListener('submit', (e)=>{
      const email = document.getElementById('contactEmail').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();
      const method = pm.value;

      if(cart.items.length===0){ e.preventDefault(); alert(currentLang==='ar'?'السلة فارغة.':(currentLang==='fr'?'Le panier est vide.':'Cart is empty.')); return; }
      if(!email && !phone){ e.preventDefault(); alert(currentLang==='ar'?'رجاءً أدخل بريدًا أو رقمًا.':(currentLang==='fr'?'Veuillez fournir un e-mail ou un téléphone.':'Provide an email or a phone number.')); return; }

      if(method!=='flexy'){
        const proofInput = document.getElementById('proofFile');
        if(!proofInput.files || proofInput.files.length === 0){
          e.preventDefault(); alert(currentLang==='ar'?'يرجى اختيار إثبات الدفع.':(currentLang==='fr'?'Veuillez joindre une preuve de paiement.':'Please choose a payment proof (image or PDF).')); return;
        }
      } else {
        const flexyTime = document.getElementById('flexyTime').value;
        const flexyAmount = document.getElementById('flexyAmount').value;
        if(!flexyTime){ e.preventDefault(); alert(currentLang==='ar'?'أدخل وقت الدفع بالضبط.':(currentLang==='fr'?'Indiquez l’heure exacte du paiement.':'Enter the exact time of payment.')); return; }
        if(!flexyAmount){ e.preventDefault(); alert(currentLang==='ar'?'أدخل المبلغ المدفوع.':(currentLang==='fr'?'Indiquez le montant payé.':'Enter the exact amount paid.')); return; }
      }

      const itemsText = cart.items
        .map(i=>`${i.name} x${i.qty} — ${(i.price*i.qty).toLocaleString('en-DZ')} DA`)
        .join('\n');

      const sub = cart.subtotal();
      const fee = (method==='flexy') ? Math.round(sub*0.18) : 0;
      const total = sub + fee;

      document.getElementById('f_items').value   = itemsText;
      document.getElementById('f_subtotal').value= `${sub.toLocaleString('en-DZ')} DA`;
      document.getElementById('f_fee').value     = fee ? `${fee.toLocaleString('en-DZ')} DA` : '0 DA';
      document.getElementById('f_total').value   = `${total.toLocaleString('en-DZ')} DA`;
      document.getElementById('f_method').value  = method.toUpperCase();
      document.getElementById('f_flexy_time').value   = (method==='flexy') ? document.getElementById('flexyTime').value : '';
      document.getElementById('f_flexy_amount').value = (method==='flexy') ? `${document.getElementById('flexyAmount').value} DA` : '';
      document.getElementById('f_notes').value        = document.getElementById('notes').value.trim();
    });

    /* =========================================================
       INIT
       ========================================================= */
    const yearEl = document.getElementById('year'); yearEl.textContent = new Date().getFullYear();
    let currentLang = (localStorage.getItem('dk_lang') || 'en');

    // Persisted setLang wrapper
    const _setLangCore = setLang;
    function setLangPersist(lang){ currentLang=lang; localStorage.setItem('dk_lang', lang); _setLangCore(lang); }
    const setLangRef = setLangPersist; // alias for calls below

    // startup
    applyFilters();
    renderCart();
    updateBadge();
    onPMChange();
    setLangRef(currentLang);

    // keep selects in sync saving choice
    langSelectHeader.addEventListener('change', e=> setLangRef(e.target.value));
    langSelectFooter.addEventListener('change', e=> setLangRef(e.target.value));

    // Grid actions (Add / Buy) need openCartDrawer
    function openCartDrawer(){ document.getElementById('cartDrawer').classList.add('open'); document.getElementById('backdrop').classList.add('show'); }
  </script>
</body>
</html>
